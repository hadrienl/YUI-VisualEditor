window.es={};es.extendClass=function(d,b){var a=new b();for(var c in a){if(typeof a[c]==="function"&&!(c in d.prototype)){d.prototype[c]=a[c]}}};es.extendObject=$.extend;es.isPlainObject=$.isPlainObject;es.isEmptyObject=$.isEmptyObject;es.isArray=$.isArray;es.inArray=$.inArray;es.compareObjects=function(e,c,h){var i,g,d,j;var f;for(f in e){i=e[f];g=c[f];d=typeof i;j=typeof g;if(d!==j||((d==="string"||d==="number")&&i!==g)||(es.isPlainObject(i)&&!es.compareObjects(i,g))){return false}}return h?true:es.compareObjects(c,e,true)};es.compareArrays=function(e,c,g){var f,j,h,d,k;if(e.length!==c.length){return false}for(f=0;f<e.length;f++){j=e[f];h=c[f];d=typeof j;k=typeof h;if(d!==k||!((es.isArray(j)&&es.isArray(h)&&es.compareArrays(j,h))||(g&&es.isPlainObject(j)&&es.compareObjects(j,h))||j===h)){return false}}return true};es.copyArray=function(e){var a=[];for(var d=0;d<e.length;d++){var c=e[d],b=typeof c;if(b==="string"||b==="number"){a.push(c)}else{if(es.isPlainObject(c)){a.push(es.copyObject(c))}else{if(es.isArray(c)){a.push(es.copyArray(c))}}}}return a};es.copyObject=function(e){var a={};for(var d in e){var c=e[d],b=typeof c;if(b==="string"||b==="number"){a[d]=c}else{if(es.isPlainObject(c)){a[d]=es.copyObject(c)}else{if(es.isArray(c)){a[d]=es.copyArray(c)}}}}return a};es.insertIntoArray=function(e,d,c){var a=0,b=1024;while(a<c.length){e.splice.apply(e,[a+d,0].concat(c.slice(a,a+b)));a+=b}};es.repeatString=function(c,b){if(b<1){return""}var a="";while(b>0){if(b&1){a+=c}b>>=1;c+=c}return a};es.Html={escapeText:function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},makeAttributeList:function(c,b){var a=[];var d;if(c){for(d in c){a.push(d+'="'+c[d]+'"')}}return(b&&a.length?" ":"")+a.join(" ")},makeOpeningTag:function(b,a){return"<"+b+es.Html.makeAttributeList(a,true)+">"},makeClosingTag:function(a){return"</"+a+">"},makeTag:function(b,a,d,c){if(d===false){return"<"+b+es.Html.makeAttributeList(a,true)+" />"}else{if(c){d=wiki.util.xml.esc(d)}return"<"+b+es.Html.makeAttributeList(a,true)+">"+d+"</"+b+">"}}};es.Position=function(c,b,a){this.left=c||0;this.top=b||0;this.bottom=a||this.top};es.Position.newFromElementPagePosition=function(a){var b=a.offset();return new es.Position(b.left,b.top)};es.Position.newFromElementLayerPosition=function(b){var a=b.position();return new es.Position(a.left,a.top)};es.Position.newFromEventScreenPosition=function(a){return new es.Position(a.screenX,a.screenY)};es.Position.newFromEventPagePosition=function(a){return new es.Position(a.pageX,a.pageY)};es.Position.newFromEventLayerPosition=function(a){return new es.Position(a.layerX,a.layerY)};es.Position.prototype.add=function(a){this.top+=a.top;this.bottom+=a.bottom;this.left+=a.left};es.Position.prototype.subtract=function(a){this.top-=a.top;this.bottom-=a.bottom;this.left-=a.left};es.Position.prototype.at=function(a){return this.left===a.left&&this.top===a.top};es.Position.prototype.perpendicularWith=function(a){return this.left===a.left||this.top===a.top};es.Position.prototype.levelWith=function(a){return this.top===a.top};es.Position.prototype.plumbWith=function(a){return this.left===a.left};es.Position.prototype.near=function(b,a){return Math.sqrt(Math.pow(this.left-b.left,2),Math.pow(this.top-b.top))<=a};es.Position.prototype.above=function(a){return this.bottom<a.top};es.Position.prototype.below=function(a){return this.top>a.bottom};es.Position.prototype.leftOf=function(a){return this.left<a};es.Position.prototype.rightOf=function(a){return this.left>a};es.Range=function(b,a){this.from=b||0;this.to=typeof a==="undefined"?this.from:a;this.normalize()};es.Range.newFromTranslatedRange=function(a,b){return new es.Range(a.from+b,a.to+b)};es.Range.prototype.clone=function(){return new es.Range(this.from,this.to)};es.Range.prototype.containsOffset=function(a){this.normalize();return a>=this.start&&a<this.end};es.Range.prototype.getLength=function(){return Math.abs(this.from-this.to)};es.Range.prototype.normalize=function(){if(this.from<this.to){this.start=this.from;this.end=this.to}else{this.start=this.to;this.end=this.from}};es.Range.prototype.equals=function(a){return this.from===a.from&&this.to===a.to};es.TransactionProcessor=function(a,b){this.model=a;this.transaction=b;this.cursor=0;this.set=[];this.clear=[]};es.TransactionProcessor.operationMap={retain:{commit:function(a){this.retain(a)},rollback:function(a){this.retain(a)}},insert:{commit:function(a){this.insert(a)},rollback:function(a){this.remove(a)}},remove:{commit:function(a){this.remove(a)},rollback:function(a){this.insert(a)}},attribute:{commit:function(a){this.attribute(a,false)},rollback:function(a){this.attribute(a,true)}},annotate:{commit:function(a){this.mark(a,false)},rollback:function(a){this.mark(a,true)}}};es.TransactionProcessor.commit=function(a,c){var b=new es.TransactionProcessor(a,c);b.process("commit")};es.TransactionProcessor.rollback=function(a,c){var b=new es.TransactionProcessor(a,c);b.process("rollback")};es.TransactionProcessor.prototype.process=function(e){var b=this.transaction.getOperations();for(var c=0,d=b.length;c<d;c++){var a=b[c];if(a.type in es.TransactionProcessor.operationMap){es.TransactionProcessor.operationMap[a.type][e].call(this,a)}else{throw"Invalid operation error. Operation type is not supported: "+a.type}}};es.TransactionProcessor.prototype.rebuildNodes=function(j,b,h,f){var d=es.DocumentModel.createNodesFromData(j),e=0;if(b){if(b[0]===b[0].getRoot()){h=b[0];f=0;e=h.getChildren().length}else{h=h||b[0].getParent();f=f||h.indexOf(b[0]);e=b.length}if(d.length&&b.length&&d[0].type===b[0].type&&!d[0].hasChildren()){var i=d.shift(),c=b.shift();var a=i.getElement().attributes,g=c.getElement().attributes;if(g||a){c.getElement().attributes=a}c.adjustContentLength(i.getContentLength()-c.getContentLength());f++;e--}}if(d.length<1024){h.splice.apply(h,[f,e].concat(d))}else{if(d.length){h.splice.apply(h,[f,e]);es.insertIntoArray(h,f,d)}}};es.TransactionProcessor.prototype.getScope=function(d,e){var b,c,f=0,a=0;for(b=0,c=e.length;b<c;b++){if(typeof e[b].type==="string"){f+=e[b].type.charAt(0)==="/"?1:-1;a=Math.max(a,f)}}if(a>0){for(b=0;b<a-1;b++){d=d.getParent()}}return d};es.TransactionProcessor.prototype.applyAnnotations=function(o,d){var f,e,c,a,b,n=0,l;if(this.set.length){for(f=0,a=this.set.length;f<a;f++){b=this.set[f];if(b.hash===undefined){b.hash=es.DocumentModel.getHash(b)}for(e=this.cursor;e<o;e++){if(es.isArray(this.model.data[e])){this.model.data[e].push(b)}else{this.model.data[e]=[this.model.data[e],b]}}}n++}if(this.clear.length){for(f=0,a=this.clear.length;f<a;f++){b=this.clear[f];if(b instanceof RegExp){for(e=this.cursor;e<o;e++){var g=es.DocumentModel.getMatchingAnnotations(this.model.data[e],b);for(c=0;c<g.length;c++){l=this.model.data[e].indexOf(g[c]);if(l!==-1){this.model.data[e].splice(l,1)}}if(this.model.data[e].length===1){this.model.data[e]=this.model.data[e][0]}}}else{if(b.hash===undefined){b.hash=es.DocumentModel.getHash(b)}for(e=this.cursor;e<o;e++){l=es.DocumentModel.getIndexOfAnnotation(this.model.data[e],b);if(l!==-1){this.model.data[e].splice(l,1)}if(this.model.data[e].length===1){this.model.data[e]=this.model.data[e][0]}}}}n++}if(d&&n){var m=this.model.getNodeFromOffset(this.cursor),h=this.model.getNodeFromOffset(o);this.model.traverseLeafNodes(function(i){i.emit("update");if(i===h){return false}},m)}};es.TransactionProcessor.prototype.retain=function(a){this.applyAnnotations(this.cursor+a.length,true);this.cursor+=a.length};es.TransactionProcessor.prototype.insert=function(d){var b,a,c;if(es.DocumentModel.isStructuralOffset(this.model.data,this.cursor)&&this.cursor!=this.model.data.length){es.insertIntoArray(this.model.data,this.cursor,d.data);this.applyAnnotations(this.cursor+d.data.length);b=this.model.getNodeFromOffset(this.cursor);c=this.model.getOffsetFromNode(b);a=b.getIndexFromOffset(this.cursor-c);this.rebuildNodes(d.data,null,b,a)}else{b=this.model.getNodeFromOffset(this.cursor);if(b.getParent()===this.model){c=this.model.getOffsetFromNode(b)}else{b=this.getScope(b,d.data);c=this.model.getOffsetFromNode(b)}if(es.DocumentModel.containsElementData(d.data)){es.insertIntoArray(this.model.data,this.cursor,d.data);this.applyAnnotations(this.cursor+d.data.length);if(c===-1){throw"Invalid offset error. Node is not in model tree"}this.rebuildNodes(this.model.data.slice(c,c+b.getElementLength()+d.data.length),[b])}else{es.insertIntoArray(this.model.data,this.cursor,d.data);this.applyAnnotations(this.cursor+d.data.length);b.adjustContentLength(d.data.length,true);b.emit("update",this.cursor-c)}}this.cursor+=d.data.length};es.TransactionProcessor.prototype.remove=function(l){if(es.DocumentModel.containsElementData(l.data)){var e=this.model.selectNodes(new es.Range(this.cursor,this.cursor+l.data.length));var o=[],k=[],m=null,h=null,n,s,u;for(u=0;u<e.length;u++){o.push(e[u].node);if(e[u].range!==undefined){if(n===undefined){n=e[u].node}var t=e[u].globalRange.start-e[u].range.start,g=t+e[u].node.getContentLength(),a=this.model.data.slice(t,g);a.splice(e[u].range.start,e[u].range.end-e[u].range.start);k=k.concat(a);s=e[u].node}}if(n!==undefined){var b=[],d=[],q=es.DocumentNode.getCommonAncestorPaths(n,s),w,v;if(!q){throw"Removal is not a valid merge: nodes do not have a common ancestor or are not at the same depth"}for(u=0;u<q.node1Path.length;u++){if(q.node1Path[u].getElementType()!==q.node2Path[u].getElementType()){throw"Removal is not a valid merge: corresponding parents have different types ( "+q.node1Path[u].getElementType()+" vs "+q.node2Path[u].getElementType()+" )"}b.push(q.node1Path[u].getElement());d.push({type:"/"+q.node2Path[u].getElementType()})}k=b.reverse().concat(k,d);w=q.node1Path.length?q.node1Path[q.node1Path.length-1]:null;v=q.node2Path.length?q.node2Path[q.node2Path.length-1]:null;if(w&&w!==o[0]){o=[w];m=q.commonAncestor;h=m.indexOf(w);if(h===-1){throw"Tree corruption detected: node isn't in its parent's children array"}var c=false;for(var r=h+1;!c&&r<m.getChildren().length;r++){o.push(m.getChildren()[r]);c=m.getChildren()[r]===v}if(!c){throw"Tree corruption detected: node isn't in its parent's children array"}}}this.model.data.splice(this.cursor,l.data.length);this.rebuildNodes(k,o,m,h)}else{var p=this.model.getNodeFromOffset(this.cursor);p.adjustContentLength(-l.data.length,true);this.model.data.splice(this.cursor,l.data.length);var f=this.model.getOffsetFromNode(p);p.emit("update",this.cursor-f)}};es.TransactionProcessor.prototype.attribute=function(f,e){var b=this.model.data[this.cursor];if(b.type===undefined){throw"Invalid element error. Can not set attributes on non-element data."}if((f.method==="set"&&!e)||(f.method==="clear"&&e)){if(!b.attributes){b.attributes={}}b.attributes[f.key]=f.value}else{if((f.method==="clear"&&!e)||(f.method==="set"&&e)){if(b.attributes){delete b.attributes[f.key]}var d=true;for(var a in b.attributes){d=false;break}if(d){delete b.attributes}}else{throw"Invalid method error. Can not operate attributes this way: "+method}}var c=this.model.getNodeFromOffset(this.cursor+1);c.traverseLeafNodes(function(g){g.emit("update")})};es.TransactionProcessor.prototype.mark=function(d,c){var b;if((d.method==="set"&&!c)||(d.method==="clear"&&c)){b=this.set}else{if((d.method==="clear"&&!c)||(d.method==="set"&&c)){b=this.clear}else{throw"Invalid method error. Can not operate attributes this way: "+method}}if(d.bias==="start"){b.push(d.annotation)}else{if(d.bias==="stop"){var a;if(d.annotation instanceof RegExp){a=b.indexOf(d.annotation)}else{a=es.DocumentModel.getIndexOfAnnotation(b,d.annotation)}if(a===-1){throw"Annotation stack error. Annotation is missing."}b.splice(a,1)}}};es.AnnotationSerializer=function(){this.annotations={}};es.AnnotationSerializer.prototype.add=function(a,c,b){if(typeof a.normalize==="function"){a.normalize()}if(!(a.start in this.annotations)){this.annotations[a.start]=[c]}else{this.annotations[a.start].push(c)}if(!(a.end in this.annotations)){this.annotations[a.end]=[b]}else{this.annotations[a.end].unshift(b)}};es.AnnotationSerializer.prototype.addTags=function(b,c,a){this.add(b,es.Html.makeOpeningTag(c,a),es.Html.makeClosingTag(c))};es.AnnotationSerializer.prototype.render=function(d){var a="";for(var b=0,c=d.length;b<=c;b++){if(b in this.annotations){a+=this.annotations[b].join("")}if(b<c){a+=d[b]}}return a};es.HtmlSerializer=function(a){this.options=$.extend({},a||{})};es.HtmlSerializer.stringify=function(b,a){return(new es.HtmlSerializer(a)).document(b)};es.HtmlSerializer.getHtmlAttributes=function(a){var d={},c=0;for(var b in a){if(b.indexOf("html/")===0){d[b.substr(5)]=a[b];c++}}return c?d:null};es.HtmlSerializer.prototype.document=function(f,d){var a=[];for(var c=0,e=f.children.length;c<e;c++){var b=f.children[c];if(b.type in this){if(b.type==="paragraph"){a.push(this.paragraph(b,d&&c===0))}else{a.push(this[b.type].call(this,b))}}}return a.join("\n")};es.HtmlSerializer.prototype.comment=function(a){return"<!--("+a.text+")-->"};es.HtmlSerializer.prototype.pre=function(a){return es.Html.makeTag("pre",{},this.content(a.content,true))};es.HtmlSerializer.prototype.horizontalRule=function(a){return es.Html.makeTag("hr",{},false)};es.HtmlSerializer.prototype.heading=function(a){return es.Html.makeTag("h"+a.attributes.level,{},this.content(a.content))};es.HtmlSerializer.prototype.paragraph=function(b,a){if(a){return this.content(b.content)}else{return es.Html.makeTag("p",{},this.content(b.content))}};es.HtmlSerializer.prototype.list=function(c){var f=[],l=[],m=[],h=[];function k(e,r){var o=Math.min(e.length,r.length);for(var p=0;p<o;p++){if(e[p]!==r[p]){var q=[e[p],r[p]].sort();if(q[0]!=="description"&&q[1]!=="term"){break}}}return p}function d(o){for(var e=0;e<o;e++){f.push(h.pop())}}function a(e,q,r){var p=k(e,q);d(h.length-p);for(var o=p;o<q.length;o++){var s=q[o];switch(s){case"bullet":f.push(es.Html.makeOpeningTag("ul",r));h.push(es.Html.makeClosingTag("ul"));break;case"number":f.push(es.Html.makeOpeningTag("ol",r));h.push(es.Html.makeClosingTag("ol"));break;case"term":case"description":f.push(es.Html.makeOpeningTag("dl",r));h.push(es.Html.makeClosingTag("dl"));break;default:throw ("Unknown node prefix "+s)}}}for(var g=0,b=c.children.length;g<b;g++){var j=c.children[g];m=j.attributes.styles;delete j.attributes.styles;a(l,m,j.attributes);var n;switch(m[m.length-1]){case"term":n="dt";break;case"description":n="dd";break;default:n="li";break}f.push(es.Html.makeTag(n,j.attributes,this.document(j)));l=m}d(h.length);return f.join("\n")};es.HtmlSerializer.prototype.table=function(e){var a=[],b=es.HtmlSerializer.getHtmlAttributes(e.attributes);a.push(es.Html.makeOpeningTag("table",b));for(var c=0,d=e.children.length;c<d;c++){var f=e.children[c];a.push(this[f.type](f))}a.push(es.Html.makeClosingTag("table"));return a.join("\n")};es.HtmlSerializer.prototype.tableRow=function(e){var a=[],b=es.HtmlSerializer.getHtmlAttributes(e.attributes);a.push(es.Html.makeOpeningTag("tr",b));for(var c=0,d=e.children.length;c<d;c++){a.push(this.tableCell(e.children[c]))}a.push(es.Html.makeClosingTag("tr"));return a.join("\n")};es.HtmlSerializer.prototype.tableCell=function(c){var b={tableHeading:"th",tableCell:"td"},a=es.HtmlSerializer.getHtmlAttributes(c.attributes);return es.Html.makeTag(b[c.type],a,this.document(c,true))};es.HtmlSerializer.prototype.tableCaption=function(a){attributes=es.HtmlSerializer.getHtmlAttributes(a.attributes);return es.Html.makeTag("caption",attributes,this.content(a.content))};es.HtmlSerializer.prototype.transclusion=function(a){var b=[];if(a.namespace!=="Main"){b.push(a.namespace)}b.push(a.title);b=b.join(":");return es.Html.makeTag("a",{href:"/wiki/"+b},b)};es.HtmlSerializer.prototype.parameter=function(a){return"{{{"+a.name+"}}}"};es.HtmlSerializer.prototype.content=function(d){if("annotations" in d&&d.annotations.length){var e=new es.AnnotationSerializer(),f={"textStyle/bold":"b","textStyle/italic":"i","textStyle/strong":"strong","textStyle/emphasize":"em","textStyle/big":"big","textStyle/small":"small","textStyle/superScript":"sup","textStyle/subScript":"sub"};for(var b=0,c=d.annotations.length;b<c;b++){var a=d.annotations[b];if(a.type in f){e.addTags(a.range,f[a.type])}else{switch(a.type){case"link/external":e.addTags(a.range,"a",{href:a.data.url});break;case"link/internal":e.addTags(a.range,"a",{href:"/wiki/"+a.data.title});break;case"object/template":case"object/hook":e.add(a.range,a.data.html,"");break}}}return e.render(d.text)}else{return d.text}};es.JsonSerializer=function(a){this.options=$.extend({indentWith:"\t",joinWith:"\n"},a||{})};es.JsonSerializer.stringify=function(b,a){return(new es.JsonSerializer(a)).stringify(b)};es.JsonSerializer.typeOf=function(a){if(typeof a==="object"){if(a===null){return"null"}switch(a.constructor){case [].constructor:return"array";case (new Date()).constructor:return"date";case (new RegExp()).constructor:return"regex";default:return"object"}}return typeof a};es.JsonSerializer.prototype.stringify=function(g,f){if(f===undefined){f=""}var d=es.JsonSerializer.typeOf(g),c;var b="";if(d==="array"){if(g.length===0){return"[]"}b+="["}else{var e=true;for(c in g){if(g.hasOwnProperty(c)){e=false;break}}if(e){return"{}"}b+="{"}var a=false;for(c in g){if(g.hasOwnProperty(c)){b+=(a?",":"")+this.options.joinWith+f+this.options.indentWith+(d==="array"?"":'"'+c+'": ');switch(es.JsonSerializer.typeOf(g[c])){case"array":case"object":b+=this.stringify(g[c],f+this.options.indentWith);break;case"boolean":case"number":b+=g[c].toString();break;case"null":b+="null";break;case"string":b+='"'+g[c].replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t")+'"';break}a=true}}b+=this.options.joinWith+f+(d==="array"?"]":"}");return b};es.WikitextSerializer=function(a){this.options=$.extend({},a||{})};es.WikitextSerializer.stringify=function(b,a){return(new es.WikitextSerializer(a)).document(b)};es.WikitextSerializer.getHtmlAttributes=function(a){var d={},c=0;for(var b in a){if(b.indexOf("html/")===0){d[b.substr(5)]=a[b];c++}}return c?d:null};es.WikitextSerializer.prototype.document=function(f,d){var a=[];for(var c=0,e=f.children.length;c<e;c++){var b=f.children[c];if(b.type in this){if(b.type==="paragraph"){a.push(this.paragraph(b,d&&c===0));if(c+1<e){a.push("")}}else{a.push(this[b.type].call(this,b))}}}return a.join("\n")};es.WikitextSerializer.prototype.comment=function(a){return"<!--"+a.text+"-->"};es.WikitextSerializer.prototype.horizontalRule=function(a){return"----"};es.WikitextSerializer.prototype.heading=function(b){var a=es.repeatString("=",b.attributes.level);return a+this.content(b.content)+a};es.WikitextSerializer.prototype.paragraph=function(a){return this.content(a.content)};es.WikitextSerializer.prototype.pre=function(a){return" "+this.content(a.content).replace("\n","\n ")};es.WikitextSerializer.prototype.list=function(g){var f={bullet:"*",number:"#",term:";",description:":"};function b(l){var h="";for(var j=0,k=l.length;j<k;j++){h+=l[j] in f?f[l[j]]:""}return h}var a=[];for(var d=0,e=g.children.length;d<e;d++){var c=g.children[d];a.push(b(c.attributes.styles)+" "+this.document(c))}return a.join("\n")+"\n"};es.WikitextSerializer.prototype.table=function(e){var a=[],b=es.WikitextSerializer.getHtmlAttributes(e.attributes);if(b){b=es.Html.makeAttributeList(b)}a.push("{|"+b);for(var c=0,d=e.children.length;c<d;c++){a.push(this.tableRow(e.children[c],c===0))}a.push("|}");return a.join("\n")};es.WikitextSerializer.prototype.tableRow=function(e,f){var a=[],b=es.WikitextSerializer.getHtmlAttributes(e.attributes);if(b){b=es.Html.makeAttributeList(b)}if(!f||b){a.push("|-"+b)}for(var c=0,d=e.children.length;c<d;c++){a.push(this.tableCell(e.children[c]))}return a.join("\n")};es.WikitextSerializer.prototype.tableCell=function(c){var b={tableHeading:"!",tableCell:"|"};var a=es.WikitextSerializer.getHtmlAttributes(c.attributes);if(a){a=es.Html.makeAttributeList(a)+"|"}return b[c.type]+a+this.document(c,true)};es.WikitextSerializer.prototype.transclusion=function(a){var b=[];if(a.namespace==="Main"){b.push("")}else{if(a.namespace!=="Template"){b.push(a.namespace)}}b.push(a.title);return"{{"+b.join(":")+"}}"};es.WikitextSerializer.prototype.parameter=function(a){return"{{{"+a.name+"}}}"};es.WikitextSerializer.prototype.content=function(e){if("annotations" in e&&e.annotations.length){var f=new es.AnnotationSerializer(),g={"textStyle/strong":"strong","textStyle/emphasize":"em","textStyle/big":"big","textStyle/small":"small","textStyle/superScript":"sup","textStyle/subScript":"sub"},d={"textStyle/bold":"'''","textStyle/italic":"''"};for(var b=0,c=e.annotations.length;b<c;b++){var a=e.annotations[b];if(a.type in g){f.addTags(a.range,g[a.type])}else{if(a.type in d){f.add(a.range,d[a.type],d[a.type])}else{switch(a.type){case"link/external":f.add(a.range,"["+a.data.href+" ","]");break;case"link/internal":f.add(a.range,"[["+a.data.title+"|","]]");break}}}}return f.render(e.text)}else{return e.text}};es.EventEmitter=function(){this.events={}};es.EventEmitter.prototype.emit=function(d){if(d==="error"&&!("error" in this.events)){throw"Missing error handler error."}if(!(d in this.events)){return false}var c=this.events[d].slice();var a=Array.prototype.slice.call(arguments,1);for(var b=0;b<c.length;b++){c[b].apply(this,a)}return true};es.EventEmitter.prototype.addListener=function(a,b){if(typeof b!=="function"){throw"Invalid listener error. Function expected."}this.emit("newListener",a,b);if(a in this.events){this.events[a].push(b)}else{this.events[a]=[b]}return this};es.EventEmitter.prototype.addListeners=function(a){for(var b in a){this.addListener(b,a[b])}return this};es.EventEmitter.prototype.addListenerMethod=function(b,a,c){return this.addListener(a,function(){if(typeof b[c]==="function"){b[c].apply(b,Array.prototype.slice.call(arguments,0))}else{throw"Listener method error. Target has no such method: "+c}})};es.EventEmitter.prototype.addListenerMethods=function(c,a){for(var b in a){this.addListenerMethod(c,b,a[b])}return this};es.EventEmitter.prototype.on=es.EventEmitter.prototype.addListener;es.EventEmitter.prototype.once=function(b,d){var c=this;return this.addListener(b,function a(){c.removeListener(b,a);d.apply(c,Array.prototype.slice.call(arguments,0))})};es.EventEmitter.prototype.removeListener=function(c,d){if(typeof d!=="function"){throw"Invalid listener error. Function expected."}if(!(c in this.events)||!this.events[c].length){return this}var a=this.events[c];if(a.length===1&&a[0]===d){delete this.events[c]}else{var b=es.inArray(d,a);if(b<0){return this}a.splice(b,1);if(a.length===0){delete this.events[c]}}return this};es.EventEmitter.prototype.removeAllListeners=function(a){if(a in this.events){delete this.events[a]}return this};es.EventEmitter.prototype.listeners=function(a){return a in this.events?this.events[a]:[]};es.DocumentNode=function(){es.EventEmitter.call(this);var a=this;this.emitUpdate=function(){a.emit("update")}};es.DocumentNode.prototype.getContentLength=function(){throw"DocumentNode.getContentLength not implemented in this subclass:"+this.constructor};es.DocumentNode.prototype.getElementLength=function(){throw"DocumentNode.getElementLength not implemented in this subclass:"+this.constructor};es.DocumentNode.prototype.hasChildren=function(){throw"DocumentNode.hasChildren not implemented in this subclass:"+this.constructor};es.DocumentNode.traverseUpstream=function(a,b){while(a){if(b(a)===false){break}a=a.getParent()}};es.DocumentNode.getCommonAncestorPaths=function(b,a){var f=[],e=[],d=b,c=a;while(d!==c){f.push(d);e.push(c);d=d.getParent();c=c.getParent();if(d===null||c===null){return false}}return{commonAncestor:d,node1Path:f,node2Path:e}};es.extendClass(es.DocumentNode,es.EventEmitter);es.DocumentModelNode=function(b,a,c){es.DocumentNode.call(this);this.type=b;this.parent=null;this.root=this;this.element=a||null;this.contentLength=c||0};es.DocumentModelNode.prototype.createView=function(){throw"DocumentModelNode.createView not implemented in this subclass:"+this.constructor};es.DocumentModelNode.prototype.getPlainObject=function(){throw"DocumentModelNode.getPlainObject not implemented in this subclass:"+this.constructor};es.DocumentModelNode.prototype.getContentLength=function(){return this.contentLength};es.DocumentModelNode.prototype.getElementLength=function(){return this.contentLength+2};es.DocumentModelNode.prototype.setContentLength=function(a){if(a<0){throw"Invalid content length error. Content length can not be less than 0."}var b=a-this.contentLength;this.contentLength=a;if(this.parent){this.parent.adjustContentLength(b)}};es.DocumentModelNode.prototype.adjustContentLength=function(b,a){this.contentLength+=b;if(this.contentLength<0){this.contentLength-=b;throw"Invalid adjustment error. Content length can not be less than 0."}if(this.parent){this.parent.adjustContentLength(b,true)}if(!a){this.emit("update")}};es.DocumentModelNode.prototype.attach=function(a){this.emit("beforeAttach",a);this.parent=a;this.setRoot(a.getRoot());this.emit("afterAttach",a)};es.DocumentModelNode.prototype.detach=function(){this.emit("beforeDetach");this.parent=null;this.clearRoot();this.emit("afterDetach")};es.DocumentModelNode.prototype.getParent=function(){return this.parent};es.DocumentModelNode.prototype.getRoot=function(){return this.root};es.DocumentModelNode.prototype.setRoot=function(a){this.root=a};es.DocumentModelNode.prototype.clearRoot=function(){this.root=null};es.DocumentModelNode.prototype.getElement=function(){return this.element};es.DocumentModelNode.prototype.getElementType=function(){return this.type};es.DocumentModelNode.prototype.getElementAttribute=function(a){if(this.element&&this.element.attributes&&a in this.element.attributes){return this.element.attributes[a]}return null};es.DocumentModelNode.prototype.getElementData=function(){var a=this.type==="document"?this:(this.root&&this.root.type==="document"?this.root:null);if(a){return a.getElementDataFromNode(this)}return[]};es.DocumentModelNode.prototype.getContentData=function(b){var a=this.type==="document"?this:(this.root&&this.root.type==="document"?this.root:null);if(a){return a.getContentDataFromNode(this,b)}return[]};es.DocumentModelNode.prototype.getContentText=function(a){var e=this.getContentData(a);var f="",c=false;for(var b=0,d=e.length;b<d;b++){if(typeof e[b].type==="string"){if(b){c=true}}else{if(c){f+="\n\n";c=false}f+=typeof e[b]==="string"?e[b]:e[b][0]}}return f};es.extendClass(es.DocumentModelNode,es.DocumentNode);es.DocumentBranchNode=function(a){this.children=es.isArray(a)?a:[]};es.DocumentBranchNode.prototype.hasChildren=function(){return true};es.DocumentBranchNode.prototype.getChildren=function(){return this.children};es.DocumentBranchNode.prototype.indexOf=function(a){return es.inArray(a,this.children)};es.DocumentBranchNode.prototype.traverseLeafNodes=function(k,j,h){var l=[],d=this,g=h?d.children.length-1:0,a,e,c,b,f;if(j!==undefined){c=j;while(c!==this){b=c.getParent();if(!b){throw"from parameter passed to traverseLeafNodes() must be a descendant"}f=b.indexOf(c);if(f===-1){throw"Tree corruption detected: node isn't in its parent's children array"}l.push(f);c=b}l=l.reverse();g=l.pop();d=j.getParent();if(h&&j.hasChildren()){g--}}while(true){a=d.children[g];if(a===undefined){if(l.length>0){d=d.getParent();g=l.pop();g+=h?-1:1;continue}else{return}}if(a.hasChildren()){d=a;l.push(g);g=h?d.children.length-1:0}else{e=k(a);if(e===false){return}g+=h?-1:1}}};es.DocumentBranchNode.prototype.getRangeFromNode=function(e,f){if(this.children.length){var c;for(var b=0,d=this.children.length,g=0;b<d;b++){c=this.children[b];if(c===e){return new es.Range(g,g+c.getElementLength())}if(!f&&c.hasChildren()&&c.getChildren().length){var a=c.getRangeFromNode(e);if(a!==null){g++;return es.Range.newFromTranslatedRange(a,g)}}g+=c.getElementLength()}}return null};es.DocumentBranchNode.prototype.getOffsetFromNode=function(d,e){if(d===this){return 0}if(this.children.length){var g=0,b;for(var a=0,c=this.children.length;a<c;a++){b=this.children[a];if(b===d){return g}if(!e&&b.hasChildren()&&b.getChildren().length){var f=this.getOffsetFromNode.call(b,d);if(f!==-1){return g+1+f}}g+=b.getElementLength()}}return -1};es.DocumentBranchNode.prototype.getNodeFromOffset=function(g,f){if(g===0){return this}if(this.children.length){var d=0,a,c;for(var b=0,e=this.children.length;b<e;b++){c=this.children[b];if(g==d){return this}a=c.getElementLength();if(g>=d&&g<d+a){if(!f&&c.hasChildren()&&c.getChildren().length){return this.getNodeFromOffset.call(c,g-d-1)}else{return c}}d+=a}if(g==d){return this}}return null};es.DocumentBranchNode.prototype.getIndexFromOffset=function(d){var c=0,a;for(var b=0;b<this.children.length;b++){a=this.children[b].getElementLength();if(d>=c&&d<c+a){return b}c+=a}return -1};es.DocumentBranchNode.prototype.selectNodes=function(m,e,h){if(typeof m==="undefined"){m=new es.Range(0,this.model.getContentLength())}else{m.normalize()}var b=[],l,k,d,o,c=m.start,g=m.end,f,n,a;h=h||0;if(c<0){throw"The start offset of the range is negative"}if(this.children.length===0){if(g>this.getContentLength()){throw"The end offset of the range is past the end of the node"}return[{node:this,range:new es.Range(c,g),globalRange:new es.Range(c+h,g+h)}]}d=1;for(l=0;l<this.children.length;l++){a=this.children[l];o=d+a.getContentLength();if(c==g&&(c==d-1||c==o+1)){return[{node:this,range:new es.Range(c,g),globalRange:new es.Range(c+h,g+h)}]}f=c>=d&&c<=o;n=g>=d&&g<=o;if(f&&n){if(e||!a.children){b=[{node:a,range:new es.Range(c-d,g-d),globalRange:new es.Range(c+h,g+h)}]}else{b=a.selectNodes(new es.Range(c-d,g-d),false,d+h)}return b}else{if(f){if(e||!a.children){b.push({node:a,range:new es.Range(c-d,o-d),globalRange:new es.Range(c+h,o+h)})}else{b=b.concat(a.selectNodes(new es.Range(c-d,o-d),false,d+h))}}else{if(n){if(e||!a.children){b.push({node:a,range:new es.Range(0,g-d),globalRange:new es.Range(d+h,g+h)})}else{b=b.concat(a.selectNodes(new es.Range(0,g-d),false,d+h))}return b}else{if(g==o+1){b.push({node:a,globalRange:new es.Range(d-1+h,o+1+h)});return b}else{if(c==d-1){b.push({node:a,globalRange:new es.Range(d-1+h,o+1+h)})}else{if(b.length>0){b.push({node:a,globalRange:new es.Range(d-1+h,o+1+h)})}}}}}}d=o+2;if(g<d){return b}}if(c>o+1){throw"The start offset of the range is past the end of the node"}else{throw"The end offset of the range is past the end of the node"}return b};es.DocumentLeafNode=function(){};es.DocumentLeafNode.prototype.hasChildren=function(){return false};es.DocumentModelBranchNode=function(c,b,d){es.DocumentBranchNode.call(this);es.DocumentModelNode.call(this,c,b,0);if(es.isArray(d)){for(var a=0;a<d.length;a++){this.push(d[a])}}};es.DocumentModelBranchNode.prototype.getPlainObject=function(){var b={type:this.type};if(this.element&&this.element.attributes){b.attributes=es.copyObject(this.element.attributes)}b.children=[];for(var a=0;a<this.children.length;a++){b.children.push(this.children[a].getPlainObject())}return b};es.DocumentModelBranchNode.prototype.push=function(a){this.emit("beforePush",a);a.attach(this);a.on("update",this.emitUpdate);this.children.push(a);this.adjustContentLength(a.getElementLength(),true);this.emit("afterPush",a);this.emit("update");return this.children.length};es.DocumentModelBranchNode.prototype.unshift=function(a){this.emit("beforeUnshift",a);a.attach(this);a.on("update",this.emitUpdate);this.children.unshift(a);this.adjustContentLength(a.getElementLength(),true);this.emit("afterUnshift",a);this.emit("update");return this.children.length};es.DocumentModelBranchNode.prototype.pop=function(){if(this.children.length){this.emit("beforePop");var a=this.children[this.children.length-1];a.detach();a.removeListener("update",this.emitUpdate);this.children.pop();this.adjustContentLength(-a.getElementLength(),true);this.emit("afterPop");this.emit("update");return a}};es.DocumentModelBranchNode.prototype.shift=function(){if(this.children.length){this.emit("beforeShift");var a=this.children[0];a.detach();a.removeListener("update",this.emitUpdate);this.children.shift();this.adjustContentLength(-a.getElementLength(),true);this.emit("afterShift");this.emit("update");return a}};es.DocumentModelBranchNode.prototype.splice=function(b,f){var c,e,a=Array.prototype.slice.call(arguments,0),g=0;this.emit.apply(this,["beforeSplice"].concat(a));if(a.length>=3){for(c=2,e=a.length;c<e;c++){a[c].attach(this);a[c].on("update",this.emitUpdate);g+=a[c].getElementLength()}}var d=this.children.splice.apply(this.children,a);for(c=0,e=d.length;c<e;c++){d[c].detach();d[c].removeListener("update",this.emitUpdate);g-=d[c].getElementLength()}this.adjustContentLength(g,true);this.emit.apply(this,["afterSplice"].concat(a));this.emit("update");return d};es.DocumentModelBranchNode.prototype.sort=function(a){this.emit("beforeSort",a);this.children.sort(a);this.emit("afterSort",a);this.emit("update")};es.DocumentModelBranchNode.prototype.reverse=function(){this.emit("beforeReverse");this.children.reverse();this.emit("afterReverse");this.emit("update")};es.DocumentModelBranchNode.prototype.setRoot=function(a){this.root=a;for(var b=0;b<this.children.length;b++){this.children[b].setRoot(a)}};es.DocumentModelBranchNode.prototype.clearRoot=function(){this.root=null;for(var a=0;a<this.children.length;a++){this.children[a].clearRoot()}};es.extendClass(es.DocumentModelBranchNode,es.DocumentBranchNode);es.extendClass(es.DocumentModelBranchNode,es.DocumentModelNode);es.DocumentModelLeafNode=function(b,a,c){es.DocumentLeafNode.call(this);es.DocumentModelNode.call(this,b,a,c);this.contentLength=c||0};es.DocumentModelLeafNode.prototype.getPlainObject=function(){var a={type:this.type};if(this.element&&this.element.attributes){a.attributes=es.copyObject(this.element.attributes)}a.content=es.DocumentModel.getExpandedContentData(this.getContentData());return a};es.extendClass(es.DocumentModelLeafNode,es.DocumentLeafNode);es.extendClass(es.DocumentModelLeafNode,es.DocumentModelNode);es.DocumentViewNode=function(b,a){es.DocumentNode.call(this);this.model=b;this.parent=null;this.$=a||$("<div/>")};es.DocumentViewNode.prototype.getElementLength=function(){return this.model.getElementLength()};es.DocumentViewNode.prototype.getContentLength=function(){return this.model.getContentLength()};es.DocumentViewNode.prototype.attach=function(a){this.parent=a;this.emit("attach",a)};es.DocumentViewNode.prototype.detach=function(){var a=this.parent;this.parent=null;this.emit("detach",a)};es.DocumentViewNode.prototype.getParent=function(){return this.parent};es.DocumentViewNode.prototype.getModel=function(){return this.model};es.DocumentViewNode.getSplitableNode=function(b){var a=null;es.DocumentNode.traverseUpstream(b,function(d){var c=d.model.getElementType();if(a!=null&&es.DocumentView.splitRules[c].children===true){return false}a=es.DocumentView.splitRules[c].self?d:null});return a};es.extendClass(es.DocumentViewNode,es.DocumentNode);es.DocumentViewBranchNode=function(c,b,a){es.DocumentBranchNode.call(this);es.DocumentViewNode.call(this,c,b);this.horizontal=a||false;if(c){var e=c.getChildren();for(var d=0;d<e.length;d++){this.onAfterPush(e[d])}this.model.addListenerMethods(this,{afterPush:"onAfterPush",afterUnshift:"onAfterUnshift",afterPop:"onAfterPop",afterShift:"onAfterShift",afterSplice:"onAfterSplice",afterSort:"onAfterSort",afterReverse:"onAfterReverse"})}};es.DocumentViewBranchNode.prototype.onAfterPush=function(b){var a=b.createView();this.emit("beforePush",a);a.attach(this);a.on("update",this.emitUpdate);this.children.push(a);this.$.append(a.$);if(this.children.length===1){a.$.addClass("es-viewBranchNode-firstChild")}this.emit("afterPush",a);this.emit("update")};es.DocumentViewBranchNode.prototype.onAfterUnshift=function(b){var a=b.createView();this.emit("beforeUnshift",a);a.attach(this);a.on("update",this.emitUpdate);this.children.unshift(a);this.$.prepend(a.$);this.emit("afterUnshift",a);this.emit("update")};es.DocumentViewBranchNode.prototype.onAfterPop=function(){this.emit("beforePop");var a=this.children.pop();a.detach();a.removeEventListener("update",this.emitUpdate);a.$.detach();this.emit("afterPop");this.emit("update")};es.DocumentViewBranchNode.prototype.onAfterShift=function(){this.emit("beforeShift");var a=this.children.shift();a.detach();a.removeEventListener("update",this.emitUpdate);a.$.detach();this.emit("afterShift");this.emit("update")};es.DocumentViewBranchNode.prototype.onAfterSplice=function(c,g){var d,f,b=Array.prototype.slice.call(arguments,0);if(b.length>=3){for(d=2,f=b.length;d<f;d++){b[d]=b[d].createView()}}this.emit.apply(this,["beforeSplice"].concat(b));var e=this.children.splice.apply(this.children,b);for(d=0,f=e.length;d<f;d++){e[d].detach();e[d].removeListener("update",this.emitUpdate);e[d].$.detach()}if(b.length>=3){var a;if(c){$anchor=this.$.children().eq(c-1)}for(d=b.length-1;d>=2;d--){b[d].attach(this);b[d].on("update",this.emitUpdate);if(c){$anchor.after(b[d].$)}else{this.$.prepend(b[d].$)}}}this.emit.apply(this,["afterSplice"].concat(b));if(b.length>=3){for(d=2,f=b.length;d<f;d++){b[d].renderContent()}}this.emit("update")};es.DocumentViewBranchNode.prototype.onAfterSort=function(){this.emit("beforeSort");var d=this.model.getChildren();for(var b=0;b<d.length;b++){for(var a=0;a<this.children.length;a++){if(this.children[a].getModel()===d[b]){var c=this.children[a];this.children.splice(a,1);this.children.push(c);this.$.append(c.$)}}}this.emit("afterSort");this.emit("update");this.renderContent()};es.DocumentViewBranchNode.prototype.onAfterReverse=function(){this.emit("beforeReverse");this.reverse();this.$.children().each(function(){$(this).prependTo($(this).parent())});this.emit("afterReverse");this.emit("update");this.renderContent()};es.DocumentViewBranchNode.prototype.renderContent=function(){for(var a=0;a<this.children.length;a++){this.children[a].renderContent()}};es.DocumentViewBranchNode.prototype.drawSelection=function(a){var d=this.selectNodes(a,true);for(var c=0;c<this.children.length;c++){if(d.length&&this.children[c]===d[0].node){for(var b=0;b<d.length;b++){d[b].node.drawSelection(d[b].range)}c+=d.length-1}else{this.children[c].clearSelection()}}};es.DocumentViewBranchNode.prototype.clearSelection=function(){for(var a=0;a<this.children.length;a++){this.children[a].clearSelection()}};es.DocumentViewBranchNode.prototype.getOffsetFromRenderedPosition=function(a){if(this.children.length===0){return 0}var c=this.children[0];for(var b=1;b<this.children.length;b++){if(this.horizontal&&this.children[b].$.offset().left>a.left){break}else{if(!this.horizontal&&this.children[b].$.offset().top>a.top){break}}c=this.children[b]}return c.getParent().getOffsetFromNode(c,true)+c.getOffsetFromRenderedPosition(a)+1};es.DocumentViewBranchNode.prototype.getRenderedPositionFromOffset=function(c,a){var b=this.getNodeFromOffset(c,true);if(b!==null){return b.getRenderedPositionFromOffset(c-this.getOffsetFromNode(b,true)-1,a)}return null};es.DocumentViewBranchNode.prototype.getRenderedLineRangeFromOffset=function(c){var b=this.getNodeFromOffset(c,true);if(b!==null){var a=this.getOffsetFromNode(b,true);return es.Range.newFromTranslatedRange(b.getRenderedLineRangeFromOffset(c-a-1),a+1)}return null};es.extendClass(es.DocumentViewBranchNode,es.DocumentBranchNode);es.extendClass(es.DocumentViewBranchNode,es.DocumentViewNode);es.DocumentViewLeafNode=function(b,a){es.DocumentLeafNode.call(this);es.DocumentViewNode.call(this,b,a);this.$content=$('<div class="es-contentView"></div>').appendTo(this.$);this.contentView=new es.ContentView(this.$content,b);this.contentView.on("update",this.emitUpdate)};es.DocumentViewLeafNode.prototype.renderContent=function(){this.contentView.render()};es.DocumentViewLeafNode.prototype.drawSelection=function(a){this.contentView.drawSelection(a)};es.DocumentViewLeafNode.prototype.clearSelection=function(){this.contentView.clearSelection()};es.DocumentViewLeafNode.prototype.getOffsetFromRenderedPosition=function(a){return this.contentView.getOffsetFromRenderedPosition(a)};es.DocumentViewLeafNode.prototype.getRenderedPositionFromOffset=function(d,c){var a=this.contentView.getRenderedPositionFromOffset(d,c),b=this.$content.offset();a.top+=b.top;a.left+=b.left;a.bottom+=b.top;return a};es.DocumentViewLeafNode.prototype.getRenderedLineRangeFromOffset=function(a){return this.contentView.getRenderedLineRangeFromOffset(a)};es.extendClass(es.DocumentViewLeafNode,es.DocumentLeafNode);es.extendClass(es.DocumentViewLeafNode,es.DocumentViewNode);es.Inspector=function(b,a){es.EventEmitter.call(this);if(!b||!a){return}this.toolbar=b;this.context=a;this.$=$('<div class="es-inspector"></div>');this.$closeButton=$('<div class="es-inspector-button es-inspector-closeButton"></div>').appendTo(this.$);this.$acceptButton=$('<div class="es-inspector-button es-inspector-acceptButton"></div>').appendTo(this.$);this.$form=$("<form></form>").appendTo(this.$);var c=this;this.$closeButton.click(function(){c.context.closeInspector(false)});this.$acceptButton.click(function(){if(!$(this).is(".es-inspector-button-disabled")){c.context.closeInspector(true)}});this.$form.submit(function(d){c.context.closeInspector(true);d.preventDefault();return false});this.$form.keydown(function(d){if(d.which===27){c.context.closeInspector(false);d.preventDefault();return false}})};es.Inspector.prototype.open=function(){this.$.show();this.context.closeMenu();if(this.onOpen){this.onOpen()}this.emit("open")};es.Inspector.prototype.close=function(a){this.$.hide();if(this.onClose){this.onClose(a)}this.emit("close");try{surfaceView.$input.focus()}catch(b){}};es.extendClass(es.Inspector,es.EventEmitter);es.Tool=function(b,a,c){this.toolbar=b;this.name=a;this.title=c;this.$=$('<div class="es-tool"></div>').attr("title",this.title)};es.Tool.tools={};es.Tool.prototype.updateState=function(){throw"Tool.updateState not implemented in this subclass:"+this.constructor};es.SurfaceModel=function(a){es.EventEmitter.call(this);this.doc=a;this.selection=null;this.smallStack=[];this.bigStack=[];this.undoIndex=0;var b=this;setInterval(function(){b.breakpoint()},750)};es.SurfaceModel.prototype.purgeHistory=function(){this.selection=null;this.smallStack=[];this.bigStack=[];this.undoIndex=0};es.SurfaceModel.prototype.getHistory=function(){if(this.smallStack.length>0){return this.bigStack.slice(0).concat([{stack:this.smallStack.slice(0)}])}else{return this.bigStack.slice(0)}};es.SurfaceModel.prototype.getDocument=function(){return this.doc};es.SurfaceModel.prototype.getSelection=function(){return this.selection};es.SurfaceModel.prototype.select=function(b,a){b.normalize();if(a){this.breakpoint()}this.selection=b;this.emit("select",this.selection.clone())};es.SurfaceModel.prototype.transact=function(a){this.bigStack=this.bigStack.slice(0,this.bigStack.length-this.undoIndex);this.undoIndex=0;this.smallStack.push(a);this.doc.commit(a);this.emit("transact",a)};es.SurfaceModel.prototype.breakpoint=function(a){if(this.smallStack.length>0){this.bigStack.push({stack:this.smallStack,selection:a||this.selection.clone()});this.smallStack=[]}};es.SurfaceModel.prototype.undo=function(){this.breakpoint();this.undoIndex++;if(this.bigStack[this.bigStack.length-this.undoIndex]){var d=0;var c=this.bigStack[this.bigStack.length-this.undoIndex];for(var a=c.stack.length-1;a>=0;a--){this.doc.rollback(c.stack[a]);d+=c.stack[a].lengthDifference}var b=c.selection;b.from-=d;b.to-=d;this.select(b)}};es.SurfaceModel.prototype.redo=function(){this.breakpoint();if(this.undoIndex>0){if(this.bigStack[this.bigStack.length-this.undoIndex]){var d=0;var c=this.bigStack[this.bigStack.length-this.undoIndex];for(var a=0;a<c.stack.length;a++){this.doc.commit(c.stack[a]);d+=c.stack[a].lengthDifference}var b=c.selection;b.from+=d;b.to+=d;this.selection=null;this.select(b)}this.undoIndex--}};es.extendClass(es.SurfaceModel,es.EventEmitter);es.DocumentModel=function(d,b){es.DocumentModelBranchNode.call(this,"document",null);this.data=es.isArray(d)?d:[];this.attributes=es.isPlainObject(b)?b:{};var a=es.DocumentModel.createNodesFromData(this.data);for(var c=0;c<a.length;c++){this.push(a[c])}};es.DocumentModel.nodeModels={};es.DocumentModel.nodeRules={document:{parents:null,children:null}};es.DocumentModel.createNodesFromData=function(d){var b=new es.DocumentModelBranchNode();for(var e=0,c=d.length;e<c;e++){if(d[e].type!==undefined){var f=d[e],h=f.type,g=h.charAt(0)!=="/";if(!g){h=h.substr(1)}if(g){if(!(h in es.DocumentModel.nodeModels)){throw"Unsuported element error. No class registered for element type: "+h}var j=new es.DocumentModel.nodeModels[f.type](f,0);b.push(j);b=j}else{b=b.getParent()}}else{var a=e;while(d[e].type===undefined&&e<c){e++}b.setContentLength(e-a);e--}}return b.getChildren().slice(0)};es.DocumentModel.newFromPlainObject=function(d){if(d.type==="document"){var c=[],a=es.isPlainObject(d.attributes)?es.copyObject(d.attributes):{};for(var b=0;b<d.children.length;b++){c=c.concat(es.DocumentModel.flattenPlainObjectElementNode(d.children[b]))}return new es.DocumentModel(c,a)}throw"Invalid object error. Object is not a valid document object."};es.DocumentModel.getHash=(window.JSON&&typeof JSON.stringify==="function")?JSON.stringify:es.JsonSerializer.stringify;es.DocumentModel.getIndexOfAnnotation=function(d,a,b){if(a===undefined||a.type===undefined){throw"Invalid annotation error. Can not find non-annotation data in character."}if(es.isArray(d)){for(var c=0;c<d.length;c++){if(typeof d[c]==="string"){continue}if((b&&d[c].type===a.type)||(!b&&d[c].hash===(a.hash||es.DocumentModel.getHash(a)))){return c}}}return -1};es.DocumentModel.getMatchingAnnotations=function(d,c){if(!(c instanceof RegExp)){throw"Invalid annotation error. Can not find non-annotation data in character."}var b=[];if(es.isArray(d)){for(var a=0;a<d.length;a++){if(typeof d[a]==="string"){continue}if(c.test(d[a].type)){b.push(d[a])}}}return b};es.DocumentModel.sortCharacterAnnotations=function(a){if(!es.isArray(a)){return}a.sort(function(d,c){var e=d.hash||es.DocumentModel.getHash(d),f=c.hash||es.DocumentModel.getHash(c);return typeof d==="string"?-1:(typeof c==="string"?1:(e==f?0:(e<f?-1:1)))})};es.DocumentModel.addAnnotationHashesToData=function(c){for(var b=0;b<c.length;b++){if(es.isArray(c[b])){for(var a=1;a<c.length;a++){if(c[b][a].hash===undefined){c[b][a].hash=es.DocumentModel.getHash(c[b][a])}}}}};es.DocumentModel.addAnnotationsToData=function(b,c){if(c&&c.length){for(var a=0;a<b.length;a++){if(es.isArray(b[a])){b[a]=[b[a]]}b[a]=[b[a]].concat(c)}}};es.DocumentModel.removeAnnotationsFromData=function(b,c){for(var a=0;a<b.length;a++){if(es.isArray(b[a])){b[a]=b[a][0]}}};es.DocumentModel.flattenPlainObjectContentNode=function(e){if(!es.isPlainObject(e)){return[]}else{var d=e.text.split("");if(es.isArray(e.annotations)){for(var b=0,c=e.annotations.length;b<c;b++){var f=e.annotations[b];var g={type:f.type};if("data" in f){g.data=es.copyObject(f.data)}g.hash=es.DocumentModel.getHash(g);if(f.range.start<0){f.range.start=0}if(f.range.end>d.length){f.range.end=d.length}for(var a=f.range.start;a<f.range.end;a++){if(typeof d[a]==="string"){d[a]=[d[a]]}d[a].push(g)}}}return d}};es.DocumentModel.flattenPlainObjectElementNode=function(d){var b,c=[],a={type:d.type};if(es.isPlainObject(d.attributes)){a.attributes=es.copyObject(d.attributes)}c.push(a);if(es.isPlainObject(d.content)){c=c.concat(es.DocumentModel.flattenPlainObjectContentNode(d.content))}else{if(es.isArray(d.children)){for(b=0;b<d.children.length;b++){c=c.concat(es.DocumentModel.flattenPlainObjectElementNode(d.children[b]))}}}c.push({type:"/"+d.type});return c};es.DocumentModel.getExpandedContentData=function(k){var m=[];function b(o,i){var j={type:i.type,range:{start:o}};if(i.data){j.data=es.copyObject(i.data)}m.push(j)}function d(p,j){for(var o=m.length-1;o>=0;o--){if(!m[o].range.end){if(j){if(m[o].type===j.type&&es.compareObjects(m[o].data,j.data)){m[o].range.end=p;break}}else{m[o].range.end=p}}}}var c="",n,a,l,h={text:""},f=0,g,e;for(g=0;g<k.length;g++){n=k[g];a=typeof c==="string";l=typeof n==="string";if(!a&&l){d(g-f)}else{if(a&&!l){for(e=1;e<n.length;e++){b(g-f,n[e])}}else{if(!a&&!l){for(e=1;e<c.length;e++){if(es.DocumentModel.getIndexOfAnnotation(k[g],c[e],true)===-1){d(g-f,c[e])}}for(e=1;e<n.length;e++){if(es.DocumentModel.getIndexOfAnnotation(k[g-1],n[e],true)===-1){b(g-f,n[e])}}}}}h.text+=l?n:n[0];c=n}if(k.length){d(g-f)}if(m.length){h.annotations=m}if(!es.isEmptyObject(this.attributes)){h.attributes=es.extendObject(true,{},this.attributes)}return h};es.DocumentModel.isContentData=function(a,b){return typeof a[b]==="string"||es.isArray(a[b])};es.DocumentModel.isElementData=function(a,b){return b>=0&&b<a.length&&a[b].type!==undefined};es.DocumentModel.isStructuralOffset=function(a,b){if(b===0||b===a.length){return true}if(a[b-1].type!==undefined&&a[b].type!==undefined){if("/"+a[b-1].type===a[b].type){return false}return true}return false};es.DocumentModel.containsElementData=function(c){for(var a=0,b=c.length;a<b;a++){if(c[a].type!==undefined){return true}}return false};es.DocumentModel.prototype.createView=function(){return new es.DocumentView(this)};es.DocumentModel.prototype.getData=function(c,b){var e=0,a;if(c!==undefined){c.normalize();e=Math.max(0,Math.min(this.data.length,c.start));a=Math.max(0,Math.min(this.data.length,c.end))}var d=a===undefined?this.data.slice(e):this.data.slice(e,a);return b?es.copyArray(d):d};es.DocumentModel.prototype.getElementFromNode=function(a){var b=this.getOffsetFromNode(a);if(b!==false){return this.data[b]}return null};es.DocumentModel.prototype.getElementDataFromNode=function(b){var a=b.getElementLength();var c=this.getOffsetFromNode(b);if(c!==-1){return this.data.slice(c,c+a)}return null};es.DocumentModel.prototype.getContentDataFromNode=function(c,a){var b=c.getContentLength();if(a){a.normalize();if(a.start<0){throw"Invalid range error. Range can not start before node start: "+a.start}if(a.end>b){throw"Invalid range error. Range can not end after node end: "+a.end}}else{a={start:0,end:b}}var d=this.getOffsetFromNode(c);if(d!==-1){if(c.type!=="document"){d++}return this.data.slice(d+a.start,d+a.end)}return null};es.DocumentModel.prototype.getAnnotationBoundaries=function(e,a,c){if(a.hash===undefined){a.hash=es.DocumentModel.getHash(a)}if(es.DocumentModel.getIndexOfAnnotation(this.data[e],a,c)===-1){return null}var f=e,b=e,d;while(f>0){f--;if(es.DocumentModel.getIndexOfAnnotation(this.data[f],a,c)===-1){f++;break}}while(b<this.data.length){if(es.DocumentModel.getIndexOfAnnotation(this.data[b],a,c)===-1){break}b++}return new es.Range(f,b)};es.DocumentModel.prototype.getAnnotationsFromOffset=function(a){if(es.isArray(this.data[a])){return es.copyArray(this.data[a].slice(1))}return[]};es.DocumentModel.prototype.getAnnotationsFromRange=function(a){a.normalize();var h={full:[],partial:[],all:[]},g={},d=0;for(var c=a.start;c<a.end;c++){if(es.DocumentModel.isElementData(this.data,c)){d++;continue}for(var b=1;b<this.data[c].length;b++){f=this.data[c][b].hash;if(f in g){g[f][1]++}else{g[f]=[this.data[c][b],1]}}}var e=a.getLength();for(var f in g){if(g[f][1]===e-d){h.full.push(g[f][0])}else{h.partial.push(g[f][0])}h.all.push(g[f][0])}return h};es.DocumentModel.prototype.getWordBoundaries=function(e){if(es.DocumentModel.isStructuralOffset(this.data,e)||es.DocumentModel.isElementData(this.data,e)){return null}var b=typeof this.data[e]==="string"?this.data[e]:this.data[e][0],d=b.match(/\B/)?/\b/:/\B/,f=e,a=e,c;while(f>0){f--;if(typeof this.data[f]!=="string"&&!es.isArray(this.data[f])){f++;break}c=typeof this.data[f]==="string"?this.data[f]:this.data[f][0];if(c.match(d)){f++;break}}while(a<this.data.length){if(typeof this.data[a]!=="string"&&!es.isArray(this.data[a])){break}c=typeof this.data[a]==="string"?this.data[a]:this.data[a][0];if(c.match(d)){break}a++}return new es.Range(f,a)};es.DocumentModel.prototype.getRelativeContentOffset=function(d,e){if(e===0){return d}var c=e>0?1:-1,b=d+c,a=0;e=Math.abs(e);while(b>0&&b<this.data.length){if(!es.DocumentModel.isStructuralOffset(this.data,b)){a++;d=b;if(e===a){return d}}b+=c}return d};es.DocumentModel.prototype.prepareInsertion=function(h,f){function e(n){var m,j=[],l,k=null;for(m=0;m<n.length;m++){if(n[m].type===undefined){}else{if(n[m].type.charAt(0)!="/"){j.push(n[m].type)}else{if(j.length===0){if(k===null){k=n.slice(0)}k.splice(m,1)}else{l=j.pop();if(l!=n[m].type.substr(1)){throw"Input is malformed: expected /"+l+" but got "+n[m].type+" at index "+m}}}}}if(j.length>0&&k===null){k=n.slice(0)}while(j.length>0){l=j.pop();k.push({type:"/"+l})}return k||n}var b=new es.TransactionModel(),d=f,g,c;if(h<0||h>this.data.length){throw"Offset "+h+" out of bounds [0.."+this.data.length+"]"}g=es.DocumentModel.isStructuralOffset(this.data,h);if(h>0){b.pushRetain(h)}if(es.DocumentModel.containsElementData(d)){if(d[0].type!==undefined&&d[0].type.charAt(0)!="/"){d=e(d);if(!g){c=this.getNodeFromOffset(h).getElementType();var a=[{type:"/"+c},{type:c}];es.insertIntoArray(a,1,d);d=a}}else{}}else{if(g){d=[{type:"paragraph"},{type:"/paragraph"}];es.insertIntoArray(d,1,f)}else{}}b.pushInsert(d);if(h<this.data.length){b.pushRetain(this.data.length-h)}return b};es.DocumentModel.prototype.prepareRemoval=function(d){function j(m,l){var k=es.DocumentNode.getCommonAncestorPaths(m,l);if(!k){return false}for(var n=0;n<k.node1Path.length;n++){if(k.node1Path[n].getElementType()!==k.node2Path[n].getElementType()){return false}}return true}var c=new es.TransactionModel(),h,g,a,e,b;d.normalize();if(d.start===d.end){c.pushRetain(this.data.length);return c}h=this.selectNodes(d);a=h[0].node;e=h[h.length-1].node;if(a&&e&&j(a,e)){if(d.start>0){c.pushRetain(d.start)}c.pushRemove(this.data.slice(d.start,d.end));if(d.end<this.data.length){c.pushRetain(this.data.length-d.end)}}else{var f=0;for(b=0;b<h.length;b++){g=h[b];if(g.globalRange.start>f){c.pushRetain(g.globalRange.start-f)}if(g.globalRange.getLength()){c.pushRemove(this.data.slice(g.globalRange.start,g.globalRange.end))}f=g.globalRange.end}if(f<this.data.length){c.pushRetain(this.data.length-f)}}return c};es.DocumentModel.prototype.prepareContentAnnotation=function(e,h,a){if(a instanceof RegExp&&h!=="clear"){throw"Invalid annotation error. RegExp patterns can only be used with the clear method."}var d=new es.TransactionModel();e.normalize();if(a.hash===undefined){a.hash=es.DocumentModel.getHash(a)}var f=e.start,g=f,c=false;while(f<e.end){if(this.data[f].type!==undefined){if(c){if(g){d.pushRetain(g)}d.pushStopAnnotating(h,a);g=0;c=false}}else{var b;if(a instanceof RegExp){b=!!es.DocumentModel.getMatchingAnnotations(this.data[f],a).length}else{b=es.DocumentModel.getIndexOfAnnotation(this.data[f],a)!==-1}if((b&&h==="set")||(!b&&h==="clear")){if(c){if(g){d.pushRetain(g)}d.pushStopAnnotating(h,a);g=0;c=false}}else{if(!c){if(g){d.pushRetain(g)}d.pushStartAnnotating(h,a);g=0;c=true}}}g++;f++}if(g){d.pushRetain(g)}if(c){d.pushStopAnnotating(h,a)}if(e.end<this.data.length){d.pushRetain(this.data.length-e.end)}return d};es.DocumentModel.prototype.prepareElementAttributeChange=function(d,e,b,c){var a=new es.TransactionModel();if(d){a.pushRetain(d)}if(this.data[d].type===undefined){throw"Invalid element offset error. Can not set attributes to non-element data."}if(this.data[d].type[0]==="/"){throw"Invalid element offset error. Can not set attributes on closing element."}a.pushChangeElementAttribute(e,b,c);if(d<this.data.length){a.pushRetain(this.data.length-d)}return a};es.DocumentModel.prototype.commit=function(a){es.TransactionProcessor.commit(this,a)};es.DocumentModel.prototype.rollback=function(a){es.TransactionProcessor.rollback(this,a)};es.DocumentModel.prototype.prepareLeafConversion=function(e,j,c){e.normalize();var b=this.getNodeFromOffset(e.start),g=this.getNodeFromOffset(e.end),a=[],h,f=[];this.traverseLeafNodes(function(i){a.push(i);if(i===g){return false}},b);for(var d=0;d<a.length;d++){h=this.getOffsetFromNode(a[d],false);f.push(this.prepareRemoval(new es.Range(h,h+a[d].getElementLength())));f.push(this.prepareInsertion(h,[{type:j,attributes:c}].concat(a[d].getContentData()).concat([{type:"/"+j}])))}return f};es.extendClass(es.DocumentModel,es.DocumentModelBranchNode);es.ParagraphModel=function(a,b){es.DocumentModelLeafNode.call(this,"paragraph",a,b)};es.ParagraphModel.prototype.createView=function(){return new es.ParagraphView(this)};es.DocumentModel.nodeModels.paragraph=es.ParagraphModel;es.DocumentModel.nodeRules.paragraph={parents:null,children:[]};es.extendClass(es.ParagraphModel,es.DocumentModelLeafNode);es.PreModel=function(a,b){es.DocumentModelLeafNode.call(this,"pre",a,b)};es.PreModel.prototype.createView=function(){return new es.PreView(this)};es.DocumentModel.nodeModels.pre=es.PreModel;es.DocumentModel.nodeRules.pre={parents:null,children:[]};es.extendClass(es.PreModel,es.DocumentModelLeafNode);es.ListModel=function(a,b){es.DocumentModelBranchNode.call(this,"list",a,b)};es.ListModel.prototype.createView=function(){return new es.ListView(this)};es.DocumentModel.nodeModels.list=es.ListModel;es.DocumentModel.nodeRules.list={parents:null,children:["listItem"]};es.extendClass(es.ListModel,es.DocumentModelBranchNode);es.ListItemModel=function(a,b){es.DocumentModelBranchNode.call(this,"listItem",a,b)};es.ListItemModel.prototype.createView=function(){return new es.ListItemView(this)};es.DocumentModel.nodeModels.listItem=es.ListItemModel;es.DocumentModel.nodeRules.listItem={parents:["list"],children:null};es.extendClass(es.ListItemModel,es.DocumentModelBranchNode);es.TableModel=function(a,b){es.DocumentModelBranchNode.call(this,"table",a,b)};es.TableModel.prototype.createView=function(){return new es.TableView(this)};es.DocumentModel.nodeModels.table=es.TableModel;es.DocumentModel.nodeRules.table={parents:null,children:["tableRow"]};es.extendClass(es.TableModel,es.DocumentModelBranchNode);es.TableRowModel=function(a,b){es.DocumentModelBranchNode.call(this,"tableRow",a,b)};es.TableRowModel.prototype.createView=function(){return new es.TableRowView(this)};es.DocumentModel.nodeModels.tableRow=es.TableRowModel;es.DocumentModel.nodeRules.tableRow={parents:["table"],children:["tableCell"]};es.extendClass(es.TableRowModel,es.DocumentModelBranchNode);es.TableCellModel=function(a,b){es.DocumentModelBranchNode.call(this,"tableCell",a,b)};es.TableCellModel.prototype.createView=function(){return new es.TableCellView(this)};es.DocumentModel.nodeModels.tableCell=es.TableCellModel;es.DocumentModel.nodeRules.tableCell={parents:["tableRow"],children:null};es.extendClass(es.TableCellModel,es.DocumentModelBranchNode);es.HeadingModel=function(a,b){es.DocumentModelLeafNode.call(this,"heading",a,b)};es.HeadingModel.prototype.createView=function(){return new es.HeadingView(this)};es.DocumentModel.nodeModels.heading=es.HeadingModel;es.DocumentModel.nodeRules.heading={parents:null,children:[]};es.extendClass(es.HeadingModel,es.DocumentModelLeafNode);es.TransactionModel=function(a){this.operations=es.isArray(a)?a:[];this.lengthDifference=0};es.TransactionModel.prototype.getOperations=function(){return this.operations};es.TransactionModel.prototype.getLengthDifference=function(){return this.lengthDifference};es.TransactionModel.prototype.pushRetain=function(b){var a=this.operations.length-1;if(this.operations.length&&this.operations[a].type==="retain"){this.operations[a].length+=b}else{this.operations.push({type:"retain",length:b})}};es.TransactionModel.prototype.pushInsert=function(b){var a=this.operations.length-1;if(this.operations.length&&this.operations[a].type==="insert"){this.operations[a].data=this.operations[a].data.concat(b)}else{this.operations.push({type:"insert",data:b})}this.lengthDifference+=b.length};es.TransactionModel.prototype.pushRemove=function(b){var a=this.operations.length-1;if(this.operations.length&&this.operations[a].type==="remove"){this.operations[a].data=this.operations[a].data.concat(b)}else{this.operations.push({type:"remove",data:b})}this.lengthDifference-=b.length};es.TransactionModel.prototype.pushChangeElementAttribute=function(c,a,b){this.operations.push({type:"attribute",method:c,key:a,value:b})};es.TransactionModel.prototype.pushStartAnnotating=function(b,a){this.operations.push({type:"annotate",method:b,bias:"start",annotation:a})};es.TransactionModel.prototype.pushStopAnnotating=function(b,a){this.operations.push({type:"annotate",method:b,bias:"stop",annotation:a})};es.LinkInspector=function(b,a){es.Inspector.call(this,b,a);this.$clearButton=$('<div class="es-inspector-button es-inspector-clearButton"></div>').prependTo(this.$);this.$.prepend('<div class="es-inspector-title">Edit link</div>');this.$locationLabel=$("<label>URL :</label>").appendTo(this.$form);this.$locationInput=$('<input type="text">').appendTo(this.$form);this.initialValue=null;var c=this;this.$clearButton.click(function(){if($(this).is(".es-inspector-button-disabled")){return}var f=c.context.getSurfaceView(),e=f.getModel(),d=e.getDocument().prepareContentAnnotation(f.currentSelection,"clear",/link\/.*/);e.transact(d);c.$locationInput.val("");c.context.closeInspector()});this.$locationInput.bind("mousedown keydown cut paste",function(){setTimeout(function(){if(c.$locationInput.val()!==c.initialValue){c.$acceptButton.removeClass("es-inspector-button-disabled")}else{c.$acceptButton.addClass("es-inspector-button-disabled")}},0)});this.$locationInput.bind("focus",function(){if(c.$locationInput.val()===""){c.$locationInput.val("http://")}})};es.LinkInspector.prototype.getTitleFromSelection=function(){var e=this.context.getSurfaceView(),b=e.getModel(),d=b.getDocument(),c=d.getData(e.currentSelection);if(c.length){var a=es.DocumentModel.getMatchingAnnotations(c[0],/link\/.*/);if(a.length){a=a[0]}if(a&&a.data&&a.data.title){return a.data.title}}return null};es.LinkInspector.prototype.onOpen=function(){var a=this.getTitleFromSelection();if(a!==null){this.$locationInput.val(a);this.$clearButton.removeClass("es-inspector-button-disabled")}else{this.$locationInput.val("");this.$clearButton.addClass("es-inspector-button-disabled")}this.$acceptButton.addClass("es-inspector-button-disabled");this.initialValue=this.$locationInput.val();var b=this;setTimeout(function(){b.$locationInput.focus().select()},0)};es.LinkInspector.prototype.onClose=function(b){if(b){var d=this.$locationInput.val();if(d===this.getTitleFromSelection()||!d){return}var f=this.context.getSurfaceView(),c=f.getModel();var a=c.getDocument().prepareContentAnnotation(f.currentSelection,"clear",/link\/.*/);c.transact(a);var e=c.getDocument().prepareContentAnnotation(f.currentSelection,"set",{type:"link/internal",data:{title:d}});c.transact(e)}};es.extendClass(es.LinkInspector,es.Inspector);es.ButtonTool=function(b,a,c){es.Tool.call(this,b,a,c);if(!a){return}this.$.addClass("es-toolbarButtonTool").addClass("es-toolbarButtonTool-"+a);var d=this;this.$.bind({mousedown:function(f){if(f.which===1){f.preventDefault();return false}},mouseup:function(f){if(f.which===1){d.onClick(f)}}})};es.ButtonTool.prototype.onClick=function(){throw"ButtonTool.onClick not implemented in this subclass:"+this.constructor};es.extendClass(es.ButtonTool,es.Tool);es.AnnotationButtonTool=function(b,a,d,c){es.ButtonTool.call(this,b,a,d);this.annotation=c.annotation;this.inspector=c.inspector;this.active=false};es.AnnotationButtonTool.prototype.onClick=function(){var e=this.toolbar.getSurfaceView();if(this.inspector){if(e.getModel().getSelection().getLength()){this.toolbar.getSurfaceView().getContextView().openInspector(this.inspector)}else{if(this.active){var c=e.getModel(),d=c.getDocument(),b=c.getSelection(),a=d.getAnnotationBoundaries(b.from,this.annotation,true);c.select(a);this.toolbar.getSurfaceView().getContextView().openInspector(this.inspector)}}}else{e.annotate(this.active?"clear":"set",this.annotation)}};es.AnnotationButtonTool.prototype.updateState=function(b,a){if(es.DocumentModel.getIndexOfAnnotation(b.full,this.annotation,true)!==-1){this.$.addClass("es-toolbarButtonTool-down");this.active=true;return}this.$.removeClass("es-toolbarButtonTool-down");this.active=false};es.Tool.tools.bold={constructor:es.AnnotationButtonTool,name:"bold",title:"Bold (ctrl/cmd + B)",data:{annotation:{type:"textStyle/bold"}}};es.Tool.tools.italic={constructor:es.AnnotationButtonTool,name:"italic",title:"Italic (ctrl/cmd + I)",data:{annotation:{type:"textStyle/italic"}}};es.Tool.tools.link={constructor:es.AnnotationButtonTool,name:"link",title:"Link (ctrl/cmd + K)",data:{annotation:{type:"link/internal",data:{title:""}},inspector:"link"}};es.Tool.tools.strong={constructor:es.AnnotationButtonTool,name:"strong",title:"Strong (ctrl/cmd + B)",data:{annotation:{type:"textStyle/strong"}}};es.Tool.tools.em={constructor:es.AnnotationButtonTool,name:"em",title:"Emphase (ctrl/cmd + I)",data:{annotation:{type:"textStyle/emphasize"}}};es.Tool.tools.del={constructor:es.AnnotationButtonTool,name:"del",title:"Del (ctrl/cmd + D)",data:{annotation:{type:"textStyle/delete"}}};es.extendClass(es.AnnotationButtonTool,es.ButtonTool);es.ClearButtonTool=function(b,a,c){es.ButtonTool.call(this,b,a,c);this.$.addClass("es-toolbarButtonTool-disabled");this.pattern=/(textStyle\/|link\/).*/};es.ClearButtonTool.prototype.onClick=function(){var c=this.toolbar.getSurfaceView(),b=c.getModel(),a=b.getDocument().prepareContentAnnotation(c.currentSelection,"clear",this.pattern);b.transact(a);c.clearInsertionAnnotations();c.getContextView().closeInspector()};es.ClearButtonTool.prototype.updateState=function(b){var a=es.DocumentModel.getMatchingAnnotations(b.all,this.pattern);if(a.length===0){this.$.addClass("es-toolbarButtonTool-disabled")}else{this.$.removeClass("es-toolbarButtonTool-disabled")}};es.Tool.tools.clear={constructor:es.ClearButtonTool,name:"clear",title:"Clear formatting"};es.extendClass(es.ClearButtonTool,es.ButtonTool);es.HistoryButtonTool=function(b,a,d,c){es.ButtonTool.call(this,b,a,d);this.data=c};es.HistoryButtonTool.prototype.onClick=function(){switch(this.name){case"undo":this.toolbar.surfaceView.model.undo(1);break;case"redo":this.toolbar.surfaceView.model.redo(1);break}};es.HistoryButtonTool.prototype.updateState=function(a){};es.Tool.tools.undo={constructor:es.HistoryButtonTool,name:"undo",title:"Undo (ctrl/cmd + Z)"};es.Tool.tools.redo={constructor:es.HistoryButtonTool,name:"redo",title:"Redo (ctrl/cmd + shift + Z)"};es.extendClass(es.HistoryButtonTool,es.ButtonTool);es.ListButtonTool=function(b,a,d,c){es.ButtonTool.call(this,b,a,d);this.data=c;this.nodes=[]};es.ListButtonTool.prototype.list=function(b,a){var c=this.toolbar.surfaceView,o=c.currentSelection.clone(),n=[],d=[],g=[],p,q,f,e,m,l,k,h;for(k=0;k<b.length;k++){p=b[k].getParent();if(p.getElementType()==="listItem"){if(n.length>0){d.push(n);n=[]}g.push(p)}else{if(n.length>0){if(p===n[n.length-1].getParent()){n.push(b[k])}else{d.push(n);n=[b[k]]}}else{n.push(b[k])}}}if(n.length>0){d.push(n)}if(d.length>0){if(o.from===o.to){o.from+=2;o.to+=2}else{if(b[0].getParent().getElementType()!="listItem"){if(o.from<o.to){o.from+=2}else{o.to+=2}}if(o.from<o.to){o.to+=(d.length*2)+(b.length-g.length-1)*2}else{o.from+=(d.length*2)+(b.length-g.length-1)*2}}}for(k=0;k<g.length;k++){q=g[k].getElementAttribute("styles");if(q[q.length-1]!==a){q.splice(q.length-1,1,a);l=c.model.getDocument().prepareElementAttributeChange(c.documentView.model.getOffsetFromNode(g[k],false),"set","styles",q);c.model.transact(l)}}for(k=0;k<d.length;k++){e=0;f=c.documentView.model.getOffsetFromNode(d[k][0],false);m=[{type:"list"}];for(h=0;h<d[k].length;h++){e+=d[k][h].getElementLength();m=m.concat([{type:"listItem",attributes:{styles:[this.name]}}]).concat([{type:"paragraph"}]).concat(d[k][h].getContentData()).concat([{type:"/paragraph"}]).concat([{type:"/listItem"}])}m=m.concat([{type:"/list"}]);l=c.model.getDocument().prepareInsertion(f,m);c.model.transact(l);l=c.model.getDocument().prepareRemoval(new es.Range(f+m.length,f+e+m.length));c.model.transact(l)}c.model.select(o,true);c.emitCursor()};es.ListButtonTool.prototype.unlist=function(k){var h=[],g,p;for(p=0;p<k.length;p++){g=k[p].getParent();if(h.length>0){if(g!=h[h.length-1]){h.push(g)}}else{h.push(g)}}var r=[],e={first:false,last:false,nodes:[],offset:0,length:0},l=this.toolbar.surfaceView,u=l.currentSelection.clone(),m=0,c=0;for(p=0;p<h.length;p++){if(e.nodes.length>0){if(e.nodes[e.nodes.length-1].getParent()!=h[p].getParent()){r.push(e);e={first:false,last:false,nodes:[],offset:0,length:0}}}if(h[p].getParent().indexOf(h[p])===0){e.first=true}if(h[p].getParent().indexOf(h[p])===h[p].getParent().children.length-1){e.last=true}if(e.nodes.length===0){e.offset=l.documentView.model.getOffsetFromNode(h[p],false)}e.length+=h[p].getElementLength();e.nodes.push(h[p])}if(e.nodes.length>0){r.push(e)}var s,o,b,t;for(p=r.length-1;p>=0;p--){e=r[p];t=[];for(o=0;o<e.nodes.length;o++){t=t.concat(e.nodes[o].getContentData())}if(e.first===true&&e.last===true){s=l.model.getDocument().prepareRemoval(new es.Range(e.offset-1,e.offset+e.length+1));l.model.transact(s);s=l.model.getDocument().prepareInsertion(e.offset-1,t);l.model.transact(s);m=-2;c+=-(e.nodes.length*2)}else{if(e.first===true&&e.last===false){s=l.model.getDocument().prepareRemoval(new es.Range(e.offset,e.offset+e.length));l.model.transact(s);s=l.model.getDocument().prepareInsertion(e.offset-1,t);l.model.transact(s);m=-2;c+=-(e.nodes.length*2)}else{if(e.first===false&&e.last===true){s=l.model.getDocument().prepareRemoval(new es.Range(e.offset,e.offset+e.length));l.model.transact(s);s=l.model.getDocument().prepareInsertion(e.offset+1,t);l.model.transact(s);c+=-(e.nodes.length*2);c+=2}else{if(e.first===false&&e.last===false){var f=e.nodes[0].getParent();var q=l.documentView.model.getOffsetFromNode(f,false);var n=f.getElementLength();s=l.model.getDocument().prepareRemoval(new es.Range(e.offset,e.offset+e.length));l.model.transact(s);var d=new es.Range(e.offset,q+n-e.length-1);var a=l.model.getDocument().getData(d);s=l.model.getDocument().prepareRemoval(d);l.model.transact(s);s=l.model.getDocument().prepareInsertion(e.offset+1,[{type:"list"}].concat(a).concat([{type:"/list"}]));l.model.transact(s);s=l.model.getDocument().prepareInsertion(e.offset+1,t);l.model.transact(s);c+=-(e.nodes.length*2);c+=2}}}}}if(u.from===u.to){u.from+=m;u.to+=m}else{if(u.to>u.from){u.from+=m;u.to+=c}else{u.to+=m;u.from+=c}}l.model.select(u,true);l.emitCursor()};es.ListButtonTool.prototype.onClick=function(){this.toolbar.surfaceView.model.breakpoint();if(!this.$.hasClass("es-toolbarButtonTool-down")){this.list(this.nodes,this.name)}else{this.unlist(this.nodes)}this.toolbar.surfaceView.model.breakpoint()};es.ListButtonTool.prototype.updateState=function(c,b){function a(d,g){var f,h;for(var e=0;e<d.length;e++){f=d[e].getParent();if(f.getElementType()!=="listItem"){return false}h=f.getElementAttribute("styles");if(h[h.length-1]!==g){return false}}return true}this.nodes=b;if(a(this.nodes,this.name)){this.$.addClass("es-toolbarButtonTool-down")}else{this.$.removeClass("es-toolbarButtonTool-down")}};es.Tool.tools.number={constructor:es.ListButtonTool,name:"number",title:"Numbered list"};es.Tool.tools.bullet={constructor:es.ListButtonTool,name:"bullet",title:"Bulleted list"};es.extendClass(es.ListButtonTool,es.ButtonTool);es.IndentationButtonTool=function(b,a,d,c){es.ButtonTool.call(this,b,a,d);this.data=c};es.IndentationButtonTool.prototype.onClick=function(){if(!this.$.hasClass("es-toolbarButtonTool-disabled")){var c=[],b,a;for(a=0;a<this.nodes.length;a++){b=this.nodes[a].getParent();if(c.length>0){if(b!=c[c.length-1]){c.push(b)}}else{c.push(b)}}if(this.name==="indent"){this.indent(c)}else{if(this.name==="outdent"){this.outdent(c)}}}};es.IndentationButtonTool.prototype.indent=function(d){var a=this.toolbar.surfaceView,c,b;for(b=0;b<d.length;b++){c=d[b].getElementAttribute("styles");if(c.length<6){c.push(c[c.length-1]);tx=a.model.getDocument().prepareElementAttributeChange(a.documentView.model.getOffsetFromNode(d[b],false),"set","styles",c);a.model.transact(tx)}}a.emitCursor()};es.IndentationButtonTool.prototype.outdent=function(d){var a=this.toolbar.surfaceView,c,b;for(b=0;b<d.length;b++){c=d[b].getElementAttribute("styles");if(c.length>1){c.splice(c.length-1,1);tx=a.model.getDocument().prepareElementAttributeChange(a.documentView.model.getOffsetFromNode(d[b],false),"set","styles",c);a.model.transact(tx)}}a.emitCursor()};es.IndentationButtonTool.prototype.updateState=function(b,a){function c(d){for(var e=0;e<d.length;e++){if(d[e].getParent().getElementType()!=="listItem"){return false}}return true}this.nodes=a;if(c(this.nodes)){this.$.removeClass("es-toolbarButtonTool-disabled")}else{this.$.addClass("es-toolbarButtonTool-disabled")}};es.extendClass(es.IndentationButtonTool,es.ButtonTool);es.DropdownTool=function(c,b,d,a){es.Tool.call(this,c,b,d);if(!b){return}var e=this;this.menuView=new es.MenuView(a,function(g){e.onSelect(g);var f=g.$.text();e.$label.text(f)},this.$);this.$label=$('<div class="es-toolbarDropdownTool-label"></div>').appendTo(this.$);$(document).add(this.toolbar.surfaceView.$).mousedown(function(f){if(f.which===1){e.menuView.close()}});this.$.bind({mousedown:function(f){if(f.which===1){f.preventDefault();return false}},mouseup:function(g){var f=$(g.target).closest(".es-menuView");if(g.which===1&&f.length===0){e.menuView.open()}else{e.menuView.close()}}});this.$.addClass("es-toolbarDropdownTool").addClass("es-toolbarDropdownTool-"+b)};es.DropdownTool.prototype.onSelect=function(a){throw"DropdownTool.onSelect not implemented in this subclass:"+this.constructor};es.extendClass(es.DropdownTool,es.Tool);es.FormatDropdownTool=function(b,a,c){es.DropdownTool.call(this,b,a,c,[{name:"paragraph",label:"Paragraph",type:"paragraph"},{name:"heading-1",label:"Heading 1",type:"heading",attributes:{level:1}},{name:"heading-2",label:"Heading 2",type:"heading",attributes:{level:2}},{name:"heading-3",label:"Heading 3",type:"heading",attributes:{level:3}},{name:"pre",label:"Preformatted",type:"pre"}])};es.FormatDropdownTool.prototype.onSelect=function(c){var a=this.toolbar.surfaceView.model.getDocument().prepareLeafConversion(this.toolbar.surfaceView.currentSelection,c.type,c.attributes);for(var b=0;b<a.length;b++){this.toolbar.surfaceView.model.transact(a[b])}};es.FormatDropdownTool.prototype.updateState=function(f,b){var d,e={type:b[0].getElementType(),attributes:b[0].getElement().attributes};for(d=1;d<b.length;d++){if(e.type!=b[d].getElementType()||!es.compareObjects(e.attributes,b[d].element.attributes)){e=null;break}}if(e===null){this.$label.html("&nbsp;")}else{var a=this.menuView.getItems();for(d=0;d<a.length;d++){if(e.type===a[d].type&&es.compareObjects(e.attributes,a[d].attributes)){var c=a[d].$.text();this.$label.text(c);break}}}};es.Tool.tools.format={constructor:es.FormatDropdownTool,name:"format",title:"Change format"};es.extendClass(es.FormatDropdownTool,es.DropdownTool);es.SurfaceView=function(d,a){es.EventEmitter.call(this);var e=this,c=$(document),b=$(window);this.model=a;this.currentSelection=new es.Range();this.documentView=new es.DocumentView(this.model.getDocument(),this);this.contextView=null;this.$=d.addClass("es-surfaceView").append(this.documentView.$);this.$input=$('<textarea class="es-surfaceView-textarea" autocapitalize="off" />').appendTo("body");this.$cursor=$('<div class="es-surfaceView-cursor"></div>').appendTo("body");this.insertionAnnotations=[];this.updateSelectionTimeout=undefined;this.emitUpdateTimeout=undefined;this.emitCursorTimeout=undefined;this.mouse={selectingMode:null,selectedRange:null};this.cursor={interval:null,initialLeft:null,initialBias:false};this.keyboard={selecting:false,cursorAnchor:null,keydownTimeout:null,keys:{shift:false}};this.dimensions={width:this.$.width(),height:b.height(),scrollTop:b.scrollTop(),toolbarHeight:d.parents(".es-base").find(".es-toolbar").height()};this.model.on("select",function(f){e.currentSelection=f.clone();e.updateSelection();if(f.getLength()){e.$input.val(e.documentView.model.getContentText(f)).select();e.clearInsertionAnnotations()}else{e.$input.val("").select();e.loadInsertionAnnotations()}});this.model.getDocument().on("update",function(){e.emitUpdate(25)});this.on("update",function(){e.updateSelection(25)});this.$.mousedown(function(f){return e.onMouseDown(f)});this.$input.bind({focus:function(){c.unbind(".es-surfaceView");c.bind({"mousemove.es-surfaceView":function(f){return e.onMouseMove(f)},"mouseup.es-surfaceView":function(f){return e.onMouseUp(f)},"keydown.es-surfaceView":function(f){return e.onKeyDown(f)},"keyup.es-surfaceView":function(f){return e.onKeyUp(f)},"copy.es-surfaceView":function(f){return e.onCopy(f)},"cut.es-surfaceView":function(f){return e.onCut(f)},"paste.es-surfaceView":function(f){return e.onPaste(f)}})},blur:function(f){c.unbind(".es-surfaceView");e.hideCursor()},paste:function(){setTimeout(function(){var j=e.$input.val(),h=j.split(""),l="",k;e.model.breakpoint();for(var g=0,f=h.length;g<f;g++){k=h[g+1];if(h[g]!=="\n"){l+=h[g]}if(!k||k==="\n"){e.$input.val(l);e.insertFromInput();if(k==="\n"&&l.length){e.handleEnter()}l=""}}e.model.breakpoint()},0)}});b.bind({resize:function(){e.hideCursor();e.dimensions.height=b.height();e.dimensions.toolbarHeight=d.parents(".es-base").find(".es-toolbar").height();var f=e.$.width();if(e.dimensions.width!==f){e.dimensions.width=f;e.documentView.renderContent();e.emitUpdate(25)}},scroll:function(){e.dimensions.scrollTop=b.scrollTop();if(e.contextView){if(e.currentSelection.getLength()&&!e.mouse.selectingMode){e.contextView.set()}else{e.contextView.clear()}}},blur:function(){e.keyboard.keys.shift=false}});this.mac=navigator.userAgent.match(/mac/i)?true:false;this.ie8=$.browser.msie&&$.browser.version==="8.0";this.documentView.renderContent()};es.SurfaceView.prototype.attachContextView=function(a){this.contextView=a};es.SurfaceView.prototype.getContextView=function(){return this.contextView};es.SurfaceView.prototype.annotate=function(d,a){if(d==="toggle"){var c=this.getAnnotations();if(es.DocumentModel.getIndexOfAnnotation(c.full,a)!==-1){d="clear"}else{d="set"}}if(this.currentSelection.getLength()){var b=this.model.getDocument().prepareContentAnnotation(this.currentSelection,d,a);this.model.transact(b)}else{if(d==="set"){this.addInsertionAnnotation(a)}else{if(d==="clear"){this.removeInsertionAnnotation(a)}}}};es.SurfaceView.prototype.getAnnotations=function(){return this.currentSelection.getLength()?this.model.getDocument().getAnnotationsFromRange(this.currentSelection):{full:this.insertionAnnotations,partial:[],all:this.insertionAnnotations}};es.SurfaceView.prototype.emitCursor=function(){if(this.emitCursorTimeout){clearTimeout(this.emitCursorTimeout)}var a=this;this.emitCursorTimeout=setTimeout(function(){var f=a.getAnnotations(),c=[],e=a.documentView.model;if(a.currentSelection.from===a.currentSelection.to){c.push(e.getNodeFromOffset(a.currentSelection.from))}else{var d=e.getNodeFromOffset(a.currentSelection.start),b=e.getNodeFromOffset(a.currentSelection.end);if(d===b){c.push(d)}else{e.traverseLeafNodes(function(g){c.push(g);if(g===b){return false}},d)}}a.emit("cursor",f,c)},50)};es.SurfaceView.prototype.getInsertionAnnotations=function(){return this.insertionAnnotations};es.SurfaceView.prototype.addInsertionAnnotation=function(a){this.insertionAnnotations.push(a);this.emitCursor()};es.SurfaceView.prototype.loadInsertionAnnotations=function(a){this.insertionAnnotations=this.model.getDocument().getAnnotationsFromOffset(this.currentSelection.to-1);for(var b=0;b<this.insertionAnnotations.length;b++){if(!this.insertionAnnotations[b].type.match(/(textStyle\/|link\/)/)){this.insertionAnnotations.splice(b,1);b--}}this.emitCursor()};es.SurfaceView.prototype.removeInsertionAnnotation=function(a){var b=es.DocumentModel.getIndexOfAnnotation(this.insertionAnnotations,a);if(b!==-1){this.insertionAnnotations.splice(b,1)}this.emitCursor()};es.SurfaceView.prototype.clearInsertionAnnotations=function(){this.insertionAnnotations=[];this.emitCursor()};es.SurfaceView.prototype.getModel=function(){return this.model};es.SurfaceView.prototype.updateSelection=function(a){var c=this;function b(){if(c.currentSelection.getLength()){c.clearInsertionAnnotations();c.hideCursor();c.documentView.drawSelection(c.currentSelection)}else{c.showCursor();c.documentView.clearSelection(c.currentSelection)}if(c.contextView){if(c.currentSelection.getLength()&&!c.mouse.selectingMode){c.contextView.set()}else{c.contextView.clear()}}c.updateSelectionTimeout=undefined}if(a){if(this.updateSelectionTimeout!==undefined){return}this.updateSelectionTimeout=setTimeout(b,a)}else{b()}};es.SurfaceView.prototype.emitUpdate=function(a){if(a){if(this.emitUpdateTimeout!==undefined){return}var b=this;this.emitUpdateTimeout=setTimeout(function(){b.emit("update");b.emitUpdateTimeout=undefined},a)}else{this.emit("update")}};es.SurfaceView.prototype.onMouseDown=function(h){if(h.which===1){var k=this.currentSelection.clone(),c=this.documentView.getOffsetFromEvent(h);if(this.ie8||h.originalEvent.detail===1){this.mouse.selectingMode=1;if(this.keyboard.keys.shift&&c!==k.from){k.to=c}else{k.from=k.to=c;var f=es.Position.newFromEventPagePosition(h),d=this.documentView.getNodeFromOffset(c,false);this.cursor.initialBias=f.left>d.contentView.$.offset().left}}else{if(h.originalEvent.detail===2){this.mouse.selectingMode=2;var b=this.model.getDocument().getWordBoundaries(c);if(b){k=b;this.mouse.selectedRange=k.clone()}}else{if(h.originalEvent.detail>=3){this.mouse.selectingMode=3;var a=this.documentView.getNodeFromOffset(c),i=this.documentView.getOffsetFromNode(a,false);k.from=this.model.getDocument().getRelativeContentOffset(i,1);k.to=this.model.getDocument().getRelativeContentOffset(i+a.getElementLength(),-1);this.mouse.selectedRange=k.clone()}}}}var g=this;function j(){if(h.which===1){g.cursor.initialLeft=null;g.model.select(k,true)}if(!g.$input.is(":focus")){g.$input.focus().select()}}if(this.ie8){setTimeout(j,0)}else{j()}return false};es.SurfaceView.prototype.onMouseMove=function(b){if(b.which===1&&this.mouse.selectingMode){var a=this.currentSelection.clone(),d=this.documentView.getOffsetFromEvent(b);if(this.mouse.selectingMode===1){a.to=d}else{if(this.mouse.selectingMode===2){var f=this.model.getDocument().getWordBoundaries(d);if(f){if(f.to<=this.mouse.selectedRange.from){a.from=f.from;a.to=this.mouse.selectedRange.to}else{a.from=this.mouse.selectedRange.from;a.to=f.to}}}else{if(this.mouse.selectingMode===3){this.mouse.selectingMode=3;var c=this.documentView.getRangeFromNode(this.documentView.getNodeFromOffset(d));if(c.to<=this.mouse.selectedRange.from){a.from=this.model.getDocument().getRelativeContentOffset(c.from,1);a.to=this.mouse.selectedRange.to}else{a.from=this.mouse.selectedRange.from;a.to=this.model.getDocument().getRelativeContentOffset(c.to,-1)}}}}this.model.select(a,true)}};es.SurfaceView.prototype.onMouseUp=function(a){if(a.which===1){this.mouse.selectingMode=this.mouse.selectedRange=null;this.model.select(this.currentSelection,true);if(this.contextView){this.contextView.set()}}};es.SurfaceView.prototype.onCopy=function(a){return true};es.SurfaceView.prototype.onCut=function(a){var b=this;setTimeout(function(){b.handleDelete()},10);return true};es.SurfaceView.prototype.onPaste=function(a){return true};es.SurfaceView.prototype.onKeyDown=function(b){switch(b.keyCode){case 9:if(!b.metaKey&&!b.ctrlKey&&!b.altKey){this.$input.val("\t");this.handleInsert();b.preventDefault();return false}return true;case 16:this.keyboard.keys.shift=true;this.keyboard.selecting=true;break;case 17:break;case 36:this.moveCursor("left","line");break;case 35:this.moveCursor("right","line");break;case 37:if(!this.mac){if(b.ctrlKey){this.moveCursor("left","word")}else{this.moveCursor("left","char")}}else{if(b.metaKey||b.ctrlKey){this.moveCursor("left","line")}else{if(b.altKey){this.moveCursor("left","word")}else{this.moveCursor("left","char")}}}break;case 38:if(!this.mac){if(b.ctrlKey){this.moveCursor("up","unit")}else{this.moveCursor("up","char")}}else{if(b.altKey){this.moveCursor("up","unit")}else{this.moveCursor("up","char")}}break;case 39:if(!this.mac){if(b.ctrlKey){this.moveCursor("right","word")}else{this.moveCursor("right","char")}}else{if(b.metaKey||b.ctrlKey){this.moveCursor("right","line")}else{if(b.altKey){this.moveCursor("right","word")}else{this.moveCursor("right","char")}}}break;case 40:if(!this.mac){if(b.ctrlKey){this.moveCursor("down","unit")}else{this.moveCursor("down","char")}}else{if(b.altKey){this.moveCursor("down","unit")}else{this.moveCursor("down","char")}}break;case 8:this.handleDelete(true);break;case 46:this.handleDelete();break;case 13:if(this.keyboard.keys.shift){this.$input.val("\n");this.handleInsert();b.preventDefault();return false}this.handleEnter();b.preventDefault();break;default:if(b.metaKey||b.ctrlKey){switch(b.keyCode){case 89:this.model.redo();return false;case 90:if(this.keyboard.keys.shift){this.model.redo()}else{this.model.undo()}return false;case 65:this.model.select(new es.Range(this.model.getDocument().getRelativeContentOffset(0,1),this.model.getDocument().getRelativeContentOffset(this.model.getDocument().getContentLength(),-1)),true);return false;case 66:this.annotate("toggle",{type:"textStyle/strong"});return false;case 73:this.annotate("toggle",{type:"textStyle/emphasize"});return false;case 75:if(this.currentSelection.getLength()){this.contextView.openInspector("link")}else{var a=this.model.getDocument().getAnnotationBoundaries(this.currentSelection.from,{type:"link/internal"},true);if(a){this.model.select(a);this.contextView.openInspector("link")}}return false;case 13:this.keyboard.keys.shift=false;if(this.keyboard.selecting){this.keyboard.selecting=false}return false}}if(!this.mac){this.handleInsert()}break}return true};es.SurfaceView.prototype.onKeyUp=function(a){if(this.mac&&a.originalEvent.keyIdentifier==="Unidentified"){return}if(a.keyCode===16){this.keyboard.keys.shift=false;if(this.keyboard.selecting){this.keyboard.selecting=false}}else{if(this.mac){this.handleInsert()}}};es.SurfaceView.prototype.handleInsert=function(){var a=this;if(a.keyboard.keydownTimeout){clearTimeout(a.keyboard.keydownTimeout)}a.keyboard.keydownTimeout=setTimeout(function(){a.insertFromInput()},10)};es.SurfaceView.prototype.handleDelete=function(h,b){var k=this.currentSelection.clone(),j,l,c,a,f;if(k.from===k.to){if(h){j=k.to;l=this.model.getDocument().getRelativeContentOffset(j,-1)}else{j=this.model.getDocument().getRelativeContentOffset(k.to,1);l=k.to}var e=this.documentView.getNodeFromOffset(j,false),i=this.documentView.getNodeFromOffset(l,false);if(e.model.getElementType()===i.model.getElementType()){c=es.DocumentViewNode.getSplitableNode(e);a=es.DocumentViewNode.getSplitableNode(i)}k.from=k.to=l;this.model.select(k);if(e===i||(typeof c!=="undefined"&&c.getParent()===a.getParent())){f=this.model.getDocument().prepareRemoval(new es.Range(l,j));this.model.transact(f,b)}else{f=this.model.getDocument().prepareInsertion(l,e.model.getContentData());this.model.transact(f,b);var d=e;es.DocumentNode.traverseUpstream(d,function(m){if(m.getParent().children.length===1){d=m.getParent();return true}else{return false}});var g=new es.Range();g.from=this.documentView.getOffsetFromNode(d,false);g.to=g.from+d.getElementLength();f=this.model.getDocument().prepareRemoval(g);this.model.transact(f,b)}}else{f=this.model.getDocument().prepareRemoval(k);this.model.transact(f,b);k.from=k.to=k.start;this.model.select(k)}};es.SurfaceView.prototype.handleEnter=function(){var e=this.currentSelection.clone(),c;if(e.from!==e.to){this.handleDelete(false,true)}var f=this.documentView.getNodeFromOffset(e.to,false),d=this.documentView.getOffsetFromNode(f,false);if(d+f.getContentLength()+1===e.to&&f===es.DocumentViewNode.getSplitableNode(f)){c=this.documentView.model.prepareInsertion(d+f.getElementLength(),[{type:"paragraph"},{type:"/paragraph"}]);this.model.transact(c);e.from=e.to=d+f.getElementLength()+1}else{var b=[],a=false;es.DocumentNode.traverseUpstream(f,function(h){var g=h.model.getElementType();if(a===true&&es.DocumentView.splitRules[g].children===true){return false}b.splice(b.length/2,0,{type:"/"+g},{type:g,attributes:es.copyObject(h.model.element.attributes)});a=es.DocumentView.splitRules[g].self;return true});c=this.documentView.model.prepareInsertion(e.to,b);this.model.transact(c);e.from=e.to=this.model.getDocument().getRelativeContentOffset(e.to,1)}this.model.select(e)};es.SurfaceView.prototype.insertFromInput=function(){var d=this.currentSelection.clone(),f=this.$input.val();if(f.length>0){var c=this.$input[0],b=document.selection&&document.selection.createRange();if(("selectionStart" in c&&c.selectionEnd-c.selectionStart)||(b&&b.text.length)){return}this.$input.val("");var a;if(d.from!=d.to){a=this.model.getDocument().prepareRemoval(d);this.model.transact(a,true);d.from=d.to=Math.min(d.from,d.to)}var e=f.split("");es.DocumentModel.addAnnotationsToData(e,this.getInsertionAnnotations());a=this.model.getDocument().prepareInsertion(d.from,e);this.model.transact(a);d.from+=f.length;d.to+=f.length;this.model.select(d)}};es.SurfaceView.prototype.moveCursor=function(k,m){if(k!=="up"&&k!=="down"){this.cursor.initialLeft=null}var n=this.currentSelection.clone(),l,c;switch(k){case"left":case"right":switch(m){case"char":case"word":if(this.keyboard.keys.shift||n.from===n.to){c=n.to}else{c=k==="left"?n.start:n.end}l=this.model.getDocument().getRelativeContentOffset(c,k==="left"?-1:1);if(m==="word"){var b=this.model.getDocument().getWordBoundaries(k==="left"?l:c);if(b){l=k==="left"?b.start:b.end}}break;case"line":c=this.cursor.initialBias?this.model.getDocument().getRelativeContentOffset(n.to,-1):n.to;var f=this.documentView.getRenderedLineRangeFromOffset(c);l=k==="left"?f.start:f.end;break;default:throw new Error("unrecognized cursor movement unit");break}break;case"up":case"down":switch(m){case"unit":var g=null;this.model.getDocument().traverseLeafNodes(function(o){var i=g===null;g=o;return i},this.documentView.getNodeFromOffset(n.to,false).getModel(),k==="up"?true:false);l=this.model.getDocument().getOffsetFromNode(g,false)+1;break;case"char":var e=this.documentView.getRenderedPositionFromOffset(n.to,this.cursor.initialBias);if(this.cursor.initialLeft===null){this.cursor.initialLeft=e.left}var j=new es.Position(this.cursor.initialLeft,e.top),d=0,a=k==="up"?-5:5,h=this.$.position().top;this.cursor.initialBias=e.left>this.documentView.getNodeFromOffset(n.to,false).contentView.$.offset().left;do{d++;j.top+=d*a;if(j.top<h){break}else{if(j.top>h+this.dimensions.height+this.dimensions.scrollTop){break}}j=this.documentView.getRenderedPositionFromOffset(this.documentView.getOffsetFromRenderedPosition(j),this.cursor.initialBias);j.left=this.cursor.initialLeft}while(e.top===j.top);l=this.documentView.getOffsetFromRenderedPosition(j);break;default:throw new Error("unrecognized cursor movement unit")}break;default:throw new Error("unrecognized cursor direction")}if(k!="up"&&k!="down"){this.cursor.initialBias=k==="right"&&m==="line"?true:false}if(this.keyboard.keys.shift&&n.from!==l){n.to=l}else{n.from=n.to=l}this.model.select(n,true)};es.SurfaceView.prototype.showCursor=function(){var b=$(window),a=this.documentView.getRenderedPositionFromOffset(this.currentSelection.to,this.cursor.initialBias);if(!a){return}this.$cursor.css({left:a.left,top:a.top,height:a.bottom-a.top}).show();this.$input.css({top:a.top,height:a.bottom-a.top});if(this.cursor.interval){clearInterval(this.cursor.interval)}var c=this;this.cursor.interval=setInterval(function(d){c.$cursor.css("display",function(e,f){return f==="block"?"none":"block"})},500)};es.SurfaceView.prototype.hideCursor=function(){if(this.cursor.interval){clearInterval(this.cursor.interval)}this.$cursor.hide()};es.extendClass(es.SurfaceView,es.EventEmitter);es.ToolbarView=function(c,e,a){es.EventEmitter.call(this);if(!e){return}var d=this,b=$(window);this.surfaceView=e;this.$=c;this.$groups=$('<div class="es-toolbarGroups"></div>').prependTo(this.$);this.tools=[];this.surfaceView.on("cursor",function(h,f){for(var g=0;g<d.tools.length;g++){d.tools[g].updateState(h,f)}});this.config=a||[{name:"history",items:["undo","redo"]},{name:"textStyle",items:["format"]},{name:"textStyle",items:["strong","em","del","link","clear"]},{name:"list",items:["number","bullet","outdent","indent"]}];this.setup()};es.ToolbarView.prototype.getSurfaceView=function(){return this.surfaceView};es.ToolbarView.prototype.setup=function(){for(var c=0;c<this.config.length;c++){var d=$("<div>").addClass("es-toolbarGroup").addClass("es-toolbarGroup-"+this.config[c].name);if(this.config[c].label){d.append($("<div>").addClass("es-toolbarLabel").html(this.config[c].label))}for(var b=0;b<this.config[c].items.length;b++){var e=es.Tool.tools[this.config[c].items[b]];if(e){var a=new e.constructor(this,e.name,e.title,e.data);this.tools.push(a);d.append(a.$)}}this.$groups.append(d)}};es.extendClass(es.ToolbarView,es.EventEmitter);es.ContentView=function(b,a){es.EventEmitter.call(this);this.$=b;this.model=a;this.boundaries=[];this.lines=[];this.width=null;this.boundaryTest=/([ \-\t\r\n\f])/g;this.widthCache={};this.renderState={};this.contentCache=null;if(a){var c=this;this.model.on("update",function(d){c.scanBoundaries();c.render(d||0)});this.$ranges=$('<div class="es-contentView-ranges"></div>');this.$rangeStart=$('<div class="es-contentView-range"></div>');this.$rangeFill=$('<div class="es-contentView-range"></div>');this.$rangeEnd=$('<div class="es-contentView-range"></div>');this.$.prepend(this.$ranges.append(this.$rangeStart,this.$rangeFill,this.$rangeEnd));this.scanBoundaries()}};es.ContentView.annotationRenderers={"object/template":{open:function(a){return'<span class="es-contentView-format-object">'+a.html},close:"</span>"},"object/hook":{open:function(a){return'<span class="es-contentView-format-object">'+a.html},close:"</span>"},"textStyle/bold":{open:'<span class="es-contentView-format-textStyle-bold">',close:"</span>"},"textStyle/italic":{open:'<span class="es-contentView-format-textStyle-italic">',close:"</span>"},"textStyle/strong":{open:'<span class="es-contentView-format-textStyle-strong">',close:"</span>"},"textStyle/emphasize":{open:'<span class="es-contentView-format-textStyle-emphasize">',close:"</span>"},"textStyle/delete":{open:'<span class="es-contentView-format-textStyle-delete">',close:"</span>"},"textStyle/big":{open:'<span class="es-contentView-format-textStyle-big">',close:"</span>"},"textStyle/small":{open:'<span class="es-contentView-format-textStyle-small">',close:"</span>"},"textStyle/superScript":{open:'<span class="es-contentView-format-textStyle-superScript">',close:"</span>"},"textStyle/subScript":{open:'<span class="es-contentView-format-textStyle-subScript">',close:"</span>"},"link/external":{open:function(a){return'<span class="es-contentView-format-link" data-href="'+a.href+'">'},close:"</span>"},"link/internal":{open:function(a){return'<span class="es-contentView-format-link" data-title="wiki/'+a.title+'">'},close:"</span>"}};es.ContentView.htmlCharacters={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#039;",'"':"&quot;","\n":'<span class="es-contentView-whitespace">&#182;</span>',"\t":'<span class="es-contentView-whitespace">&#8702;</span>'," ":"&nbsp;"};es.ContentView.renderAnnotation=function(d,b,a){var c=es.ContentView.annotationRenderers,g=b.type,e="";if(g in c){if(d==="open"){a.push(b);e+=typeof c[g].open==="function"?c[g].open(b.data):c[g].open}else{if(a[a.length-1]===b){a.pop();e+=typeof c[g].close==="function"?c[g].close(b.data):c[g].close}else{var h=es.inArray(b,a),f;if(h===-1){throw"Invalid stack error. An element is missing from the stack."}for(f=a.length-1;f>=h+1;f--){e+=typeof c[a[f].type].close==="function"?c[a[f].type].close(a[f].data):c[a[f].type].close}e+=typeof c[g].close==="function"?c[g].close(b.data):c[g].close;for(f=h+1;f<a.length;f++){e+=typeof c[a[f].type].open==="function"?c[a[f].type].open(a[f].data):c[a[f].type].open}a.splice(h,1)}}}return e};es.ContentView.prototype.drawSelection=function(c){if(typeof c==="undefined"){c=new es.Range(0,this.model.getContentLength())}else{c.normalize()}var e=this.getRenderedLineIndexFromOffset(c.start),a=this.getRenderedLineIndexFromOffset(c.end),d=this.getRenderedPositionFromOffset(c.start),f=this.getRenderedPositionFromOffset(c.end);if(e===a){if(f.left-d.left){this.$rangeStart.css({top:d.top,left:d.left,width:f.left-d.left,height:d.bottom-d.top}).show()}this.$rangeFill.hide();this.$rangeEnd.hide()}else{var b=this.$.width();if(b-d.left){this.$rangeStart.css({top:d.top,left:d.left,width:b-d.left,height:d.bottom-d.top}).show()}else{this.$rangeStart.hide()}if(f.left){this.$rangeEnd.css({top:f.top,left:0,width:f.left,height:f.bottom-f.top}).show()}else{this.$rangeEnd.hide()}if(e+1<a){this.$rangeFill.css({top:d.bottom,left:0,width:b,height:f.top-d.bottom}).show()}else{this.$rangeFill.hide()}}};es.ContentView.prototype.clearSelection=function(){this.$rangeStart.hide();this.$rangeFill.hide();this.$rangeEnd.hide()};es.ContentView.prototype.getRenderedLineIndexFromOffset=function(b){for(var a=0;a<this.lines.length;a++){if(this.lines[a].range.containsOffset(b)){return a}}return this.lines.length-1};es.ContentView.prototype.getRenderedLineIndexFromPosition=function(a){var b=this.lines.length;if(!b||a.top<0){return 0}var c=0,d=0;while(c<b){d+=this.lines[c].height;if(a.top<d){break}c++}if(c===b){return c-1}return c};es.ContentView.prototype.getRenderedLineRangeFromOffset=function(b){for(var a=0;a<this.lines.length;a++){if(this.lines[a].range.containsOffset(b)){return this.lines[a].range}}return this.lines[this.lines.length-1].range};es.ContentView.prototype.getOffsetFromRenderedPosition=function(b){if(this.model.getContentLength()===0){return 0}b.subtract(es.Position.newFromElementPagePosition(this.$));var c=this.lines[this.getRenderedLineIndexFromPosition(b)];var e=$('<div class="es-contentView-ruler"></div>').appendTo(this.$),g=e[0],d=this.fitCharacters(c.range,g,b.left),a;g.innerHTML=this.getHtml(new es.Range(c.range.start,d.end));if(d.end<this.model.getContentLength()){var f=g.clientWidth;g.innerHTML=this.getHtml(new es.Range(c.range.start,d.end+1));a=Math.round(f+((g.clientWidth-f)/2))}else{a=g.clientWidth}e.remove();this.boundaryTest.lastIndex=0;return Math.min(d.end+(b.left>=a?1:0),c.range.end)};es.ContentView.prototype.getRenderedPositionFromOffset=function(g,d){if(g<0){throw"Out of range error. Offset is expected to be greater than or equal to 0."}else{if(g>this.model.getContentLength()){throw"Out of range error. Offset is expected to be less than or equal to text length."}}var c,b=this.lines.length,f=0,a=new es.Position();while(f<b){c=this.lines[f];if(c.range.containsOffset(g)||(d&&c.range.end===g)){a.bottom=a.top+c.height;break}a.top+=c.height;f++}if(f===b){a.bottom=a.top;a.top-=c.height}if(c.range.start<g){var e=$('<div class="es-contentView-ruler"></div>').appendTo(this.$),h=e[0];h.innerHTML=this.getHtml(new es.Range(c.range.start,g));a.left=h.clientWidth;e.remove()}return a};es.ContentView.prototype.scanBoundaries=function(){var e=this.contentCache=this.model.getContentData(),f="";for(var c=0,d=e.length;c<d;c++){f+=typeof e[c]==="string"?e[c]:e[c][0]}this.boundaries=[0];this.boundaryTest.lastIndex=0;var b,a;while((b=this.boundaryTest.exec(f))){a=b.index+1;this.boundaries.push(a)}if(a<f.length||this.boundaries.length===1){this.boundaries.push(f.length)}};es.ContentView.prototype.renderIteration=function(f){var e=this.renderState,b=0,g=false,j=this.boundaries[e.wordOffset],h,c=null,l=0,a=null,i=this.boundaries.length;while(++b<=f&&e.wordOffset<i-1){c=this.fitWords(new es.Range(e.wordOffset,i-1),e.ruler,e.width);g=false;if(c.width>e.width){l=j;var d=e.wordOffset;e.wordOffset++;h=this.boundaries[e.wordOffset];do{a=this.fitCharacters(new es.Range(l,h),e.ruler,e.width);if(a.end===h){c=this.fitWords(new es.Range(e.wordOffset,i-1),e.ruler,e.width-a.width);if(c.end>e.wordOffset){d=e.wordOffset;e.wordOffset=c.end;a.end=h=this.boundaries[e.wordOffset]}}this.appendLine(new es.Range(l,a.end),d,g);l=a.end;g=true}while(l<h)}else{h=this.boundaries[c.end];this.appendLine(new es.Range(j,h),e.wordOffset,g);e.wordOffset=c.end}j=h}if(e.wordOffset>=i-1){e.$ruler.remove();if(e.line<this.lines.length){this.lines.splice(e.line,this.lines.length-e.line)}this.$.find(".es-contentView-line[line-index="+(this.lines.length-1)+"]").nextAll().remove();e.timeout=undefined;this.emit("update")}else{e.ruler.innerHTML="";var k=this;e.timeout=setTimeout(function(){k.renderIteration(3)},0)}};es.ContentView.prototype.render=function(e){var b=this.renderState;if(b.timeout!==undefined){clearTimeout(b.timeout);b.$ruler.remove()}this.widthCache={};if(this.model.getContentLength()===0){var d=$('<div class="es-contentView-line" line-index="0">&nbsp;</div>');this.$.children().remove(".es-contentView-line").end().append(d);this.lines=[{text:" ",range:new es.Range(0,0),width:0,height:d.outerHeight(),wordOffset:0,fractional:false}];this.emit("update");return}b.$ruler=$("<div>&nbsp;</div>").appendTo(this.$);b.width=b.$ruler.innerWidth();b.ruler=b.$ruler.addClass("es-contentView-ruler")[0];if(this.width!==b.width){e=undefined}this.width=b.width;if(e){var g,f=this.lines.length-1;for(var c=this.lines.length-1;c>=0;c--){var a=this.lines[c];if(a.range.start<e&&a.range.end>e){f=c}if((a.range.end<e&&!a.fractional)||c===0){b.line=c;b.wordOffset=a.wordOffset;g=f-c;break}}this.renderIteration(2+g)}else{b.line=0;b.wordOffset=0;this.renderIteration(3)}};es.ContentView.prototype.appendLine=function(b,c,e){var a=this.renderState,d=this.$.children("[line-index="+a.line+"]");if(!d.length){d=$('<div class="es-contentView-line" line-index="'+a.line+'"></div>');this.$.append(d)}d[0].innerHTML=this.getHtml(b);this.lines[a.line]={text:this.model.getContentText(b),range:b,width:d.outerWidth(),height:d.outerHeight(),wordOffset:c,fractional:e};d.find(".es-contentView-format-object a").mousedown(function(f){f.preventDefault()}).click(function(f){f.preventDefault()});a.line++};es.ContentView.prototype.fitWords=function(f,k,b){var e=f.start,a=f.start,d=f.end,j=this.boundaries[e],l,c,g,i;do{l=Math.ceil((a+d)/2);c=this.boundaries[l];i=j+":"+c;k.innerHTML=this.getHtml(new es.Range(j,c));this.widthCache[i]=g=k.clientWidth;if(g>b){if(l-e===1){a=l;break}d=l-1}else{a=l}}while(a<d);if(d===l-1){var h=this.boundaries[a];k.innerHTML=this.getHtml(new es.Range(j,h));g=this.widthCache[j+":"+h]=k.clientWidth}return{end:a,width:g}};es.ContentView.prototype.fitCharacters=function(e,h,b){var d=e.start,a=e.start,c=e.end,i,f,g;do{i=Math.ceil((a+c)/2);g=d+":"+i;if(g in this.widthCache){f=this.widthCache[g]}else{h.innerHTML=this.getHtml(new es.Range(d,i));this.widthCache[g]=f=h.clientWidth}if(f>b){if(i-d===1){a=i-1;break}c=i-1}else{a=i}}while(a<c);if(c===i-1){g=d+":"+a;if(g in this.widthCache){f=this.widthCache[g]}else{h.innerHTML=this.getHtml(new es.Range(d,a));f=this.widthCache[g]=h.clientWidth}}return{end:a,width:f}};es.ContentView.prototype.getHtml=function(l,o){if(l){l.normalize()}else{l={start:0,end:undefined}}var h=this.contentCache.slice(l.start,l.end),b=es.ContentView.renderAnnotation,p=es.ContentView.htmlCharacters;var f="",c="",n,a,k,m=[],e,g,d;for(g=0;g<h.length;g++){n=h[g];a=typeof c==="string";k=typeof n==="string";if(!a&&k){for(d=1;d<c.length;d++){f+=b("close",c[d],m)}}else{if(a&&!k){for(d=1;d<n.length;d++){f+=b("open",n[d],m)}}else{if(!a&&!k){for(d=1;d<c.length;d++){if(es.inArray(c[d],n)===-1){f+=b("close",c[d],m)}}for(d=1;d<n.length;d++){if(es.inArray(n[d],c)===-1){f+=b("open",n[d],m)}}}}}e=k?n:n[0];f+=e in p?p[e]:e;c=n}if(!k&&n){for(d=1;d<n.length;d++){f+=b("close",n[d],m)}}return f};es.extendClass(es.ContentView,es.EventEmitter);es.ContextView=function(c,a){if(!c){return}this.surfaceView=c;this.surfaceView.attachContextView(this);this.inspectors={};this.inspector=null;this.position=null;this.$=$('<div class="es-contextView"></div>').appendTo(a||$("body"));this.$toolbar=$('<div class="es-contextView-toolbar"></div>');this.$inspectors=$('<div class="es-contextView-inspectors"></div>').appendTo(this.$);this.$icon=$('<div class="es-contextView-icon"></div>').appendTo(this.$);this.toolbarView=new es.ToolbarView(this.$toolbar,this.surfaceView,[{name:"textStyle",items:["strong","em","del","link","clear"]}]);this.menuView=new es.MenuView([{name:"tools","$":this.$toolbar}],null,this.$);var b=this;this.$icon.bind({mousedown:function(d){if(d.which===1){d.preventDefault();return false}},mouseup:function(d){if(d.which===1){if(b.inspector){b.closeInspector()}else{if(b.isMenuOpen()){b.closeMenu()}else{b.openMenu()}}}}});this.addInspector("link",new es.LinkInspector(this.toolbarView,this))};es.ContextView.prototype.getSurfaceView=function(){return this.surfaceView};es.ContextView.prototype.openMenu=function(){this.menuView.open()};es.ContextView.prototype.closeMenu=function(){this.menuView.close()};es.ContextView.prototype.isMenuOpen=function(){return this.menuView.isOpen()};es.ContextView.prototype.set=function(){this.positionIcon();if(this.position){this.positionOverlay(this.menuView.$);if(this.inspector){this.positionOverlay(this.inspectors[this.inspector].$)}}};es.ContextView.prototype.positionIcon=function(){this.$.removeClass("es-contextView-position-start es-contextView-position-end");var a=this.surfaceView.getModel().getSelection(),c;this.position=null;if(a.from<a.to){var b=this.surfaceView.$.find(".es-contentView-range:visible:last");if(b.length){c=b.offset();this.position=new es.Position(c.left+b.width(),c.top+b.height());this.$.addClass("es-contextView-position-end")}}else{if(a.from>a.to){var d=this.surfaceView.$.find(".es-contentView-range:visible:first");if(d.length){c=d.offset();this.position=new es.Position(c.left,c.top);this.$.addClass("es-contextView-position-start")}}}if(this.position){this.$.css({left:this.position.left,top:this.position.top});this.$icon.fadeIn("fast")}else{this.$icon.hide()}};es.ContextView.prototype.positionOverlay=function(g){this.$.removeClass("es-contextView-position-below es-contextView-position-above");var d=5,e=g.outerWidth(),h=g.outerHeight(),b=$(window),c=b.width(),a=b.height(),f=b.scrollTop();var i=-Math.round(e/2);if((this.position.left-d)+i<0){i-=this.position.left+i-d}else{if((d+this.position.left)-i>c){i+=c-d-(this.position.left-i)}}g.css("left",i);if(this.position.top+h+(d*2)<a+f){this.$.addClass("es-contextView-position-below")}else{this.$.addClass("es-contextView-position-above")}};es.ContextView.prototype.clear=function(){if(this.inspector){this.closeInspector()}this.$icon.hide();this.menuView.close()};es.ContextView.prototype.openInspector=function(a){if(!(a in this.inspectors)){throw"Missing inspector error. Can not open nonexistent inspector: "+a}this.inspectors[a].open();this.$inspectors.show();this.positionOverlay(this.inspectors[a].$);this.inspector=a};es.ContextView.prototype.closeInspector=function(a){if(this.inspector){this.inspectors[this.inspector].close(a);this.$inspectors.hide();this.inspector=null}};es.ContextView.prototype.getInspector=function(a){if(a in this.inspectors){return this.inspectors[a]}return null};es.ContextView.prototype.addInspector=function(a,b){if(a in this.inspectors){throw"Duplicate inspector error. Previous registration with the same name: "+a}this.inspectors[a]=b;this.$inspectors.append(b.$)};es.ContextView.prototype.removeInspector=function(a){if(a in this.inspectors){throw"Missing inspector error. Can not remove nonexistent inspector: "+a}this.inspectors[a].detach();delete this.inspectors[a];this.inspector=null};es.DocumentView=function(a,b){es.DocumentViewBranchNode.call(this,a);this.surfaceView=b;this.$.addClass("es-documentView")};es.DocumentView.splitRules={};es.DocumentView.prototype.getOffsetFromEvent=function(b){var a=es.Position.newFromEventPagePosition(b);return this.getOffsetFromRenderedPosition(a)};es.DocumentView.splitRules.document={self:false,children:true};es.extendClass(es.DocumentView,es.DocumentViewBranchNode);es.ParagraphView=function(a){es.DocumentViewLeafNode.call(this,a);this.$.addClass("es-paragraphView")};es.DocumentView.splitRules.paragraph={self:true,children:null};es.extendClass(es.ParagraphView,es.DocumentViewLeafNode);es.PreView=function(a){es.DocumentViewLeafNode.call(this,a);this.$.addClass("es-preView")};es.DocumentView.splitRules.pre={self:true,children:null};es.extendClass(es.PreView,es.DocumentViewLeafNode);es.ListView=function(a){es.DocumentViewBranchNode.call(this,a);this.$.addClass("es-listView");var b=this;this.model.on("update",function(){b.enumerate()});this.enumerate()};es.ListView.prototype.enumerate=function(){var b,c=[];for(var a=0;a<this.children.length;a++){b=this.children[a].model.getElementAttribute("styles");c=c.slice(0,b.length);if(b[b.length-1]==="number"){if(!c[b.length-1]){c[b.length-1]=0}this.children[a].$icon.text(++c[b.length-1]+".")}else{this.children[a].$icon.text("");if(c[b.length-1]){c[b.length-1]=0}}}};es.DocumentView.splitRules.list={self:false,children:true};es.extendClass(es.ListView,es.DocumentViewBranchNode);es.MenuView=function(b,e,a){this.$=$('<div class="es-menuView"></div>').appendTo(a||$("body"));this.items=[];this.autoNamedBreaks=0;this.callback=e;if(es.isArray(b)){for(var c=0;c<b.length;c++){this.addItem(b[c])}}var d=this;this.$.bind({mousedown:function(f){if(f.which===1){f.preventDefault();return false}},mouseup:function(j){if(j.which===1){var f=$(j.target).closest(".es-menuView-item");if(f.length){var g=f.attr("rel");for(var h=0;h<d.items.length;h++){if(d.items[h].name===g){d.onSelect(d.items[h],j);return true}}}}}})};es.MenuView.prototype.addItem=function(b,c){if(b==="-"){b={name:"break-"+this.autoNamedBreaks++}}if(!b.$){if(!b.name){throw"Invalid menu item error. Items must have a name property."}if(b.label){b.$=$('<div class="es-menuView-item"></div>').attr("rel",b.name).append($("<span></span>").text(b.label))}else{b.$=$('<div class="es-menuView-break"></div>').attr("rel",b.name)}}if(c){for(var a=0;a<this.items.length;a++){if(this.items[a].name===c){this.items.splice(a,0,b);this.items[a].$.before(b.$);return}}}this.items.push(b);this.$.append(b.$)};es.MenuView.prototype.removeItem=function(a){for(var b=0;b<this.items.length;b++){if(this.items[b].name===a){this.items.splice(b,1);b--}}};es.MenuView.prototype.getItems=function(){return this.items};es.MenuView.prototype.setPosition=function(a){return this.$.css({top:a.top,left:a.left})};es.MenuView.prototype.open=function(){this.$.show()};es.MenuView.prototype.close=function(){this.$.hide()};es.MenuView.prototype.isOpen=function(){return this.$.is(":visible")};es.MenuView.prototype.onSelect=function(b,a){if(typeof b.callback==="function"){b.callback(b)}else{if(typeof this.callback==="function"){this.callback(b)}}this.close()};es.ListItemView=function(a){es.DocumentViewBranchNode.call(this,a);this.$icon=$('<div class="es-listItemView-icon"></div>').prependTo(this.$);this.currentStylesHash=null;this.$.addClass("es-listItemView");var b=this;this.model.on("update",function(){b.setClasses()});this.setClasses()};es.ListItemView.prototype.setClasses=function(){var c=this.model.getElementAttribute("styles"),a=c.join("|");if(this.currentStylesHash!==a){this.currentStylesHash=a;var b=this.$.attr("class");this.$.attr("class",b.replace(/ ?es-listItemView-level[0-9]+/,"").replace(/ ?es-listItemView-(bullet|number|term|definition)/,"")).addClass("es-listItemView-"+c[c.length-1]).addClass("es-listItemView-level"+(c.length-1))}};es.DocumentView.splitRules.listItem={self:true,children:false};es.extendClass(es.ListItemView,es.DocumentViewBranchNode);es.TableView=function(a){es.DocumentViewBranchNode.call(this,a,$("<table>"));this.$.attr("style",a.getElementAttribute("html/style")).addClass("es-tableView")};es.DocumentView.splitRules.table={self:false,children:false};es.extendClass(es.TableView,es.DocumentViewBranchNode);es.TableRowView=function(a){es.DocumentViewBranchNode.call(this,a,$("<tr>"),true);this.$.attr("style",a.getElementAttribute("html/style")).addClass("es-tableRowView")};es.DocumentView.splitRules.tableRow={self:false,children:false};es.extendClass(es.TableRowView,es.DocumentViewBranchNode);es.TableCellView=function(a){es.DocumentViewBranchNode.call(this,a,$("<td>"));this.$.attr("style",a.getElementAttribute("html/style")).addClass("es-tableCellView")};es.DocumentView.splitRules.tableCell={self:false,children:true};es.extendClass(es.TableCellView,es.DocumentViewBranchNode);es.HeadingView=function(a){es.DocumentViewLeafNode.call(this,a);this.currentLevelHash=null;this.$.addClass("es-headingView");var b=this;this.model.on("update",function(){b.setClasses()});this.setClasses()};es.HeadingView.prototype.setClasses=function(){var b=this.model.getElementAttribute("level");if(b!==this.currentLevelHash){this.currentLevelHash=b;var a=this.$.attr("class");this.$.attr("class",a.replace(/ ?es-headingView-level[0-9]+/,"")).addClass("es-headingView-level"+b)}};es.DocumentView.splitRules.heading={self:true,children:null};es.extendClass(es.HeadingView,es.DocumentViewLeafNode);